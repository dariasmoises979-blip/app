name: Run Unit Tests

on:
  push:
    branches:
      - main 
      - feature/** # se ejecuta cuando hay un push a main

jobs:
  test:
    name: Run Unit Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/test.yml@main
   
  create-pr:
    name: Create PR from feature to dev
    needs: test
    if: ${{ success() && startsWith(github.ref, 'refs/heads/feature/') }} #Este job espera a que termine otro job llamado "test". Solo se ejecuta si "test" termina.
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Create Pull Request to dev branch
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
          base: dev
          title: "Merge ${{ github.ref_name }} → dev"
          body: |
            ✅ Tests passed successfully on `${{ github.ref_name }}`
            
            **Branch:** `${{ github.ref_name }}`
            **Target:** `dev`
            **Commit:** ${{ github.sha }}
          commit-message: "Merge ${{ github.ref_name }} to dev"

      - name: Auto-merge PR
        if: steps.cpr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
########################################
# ğŸ”¥ WORKFLOW: Hotfix Multi-Merge
# Fusiona automÃ¡ticamente las ramas hotfix/* tanto a main como a dev
# despuÃ©s de que los tests crÃ­ticos pasen correctamente.
########################################

name: Hotfix to Main and Dev

# ğŸ¯ Se activa cuando hay push a cualquier rama hotfix/*
on:
  push:
    branches:
      - 'hotfix/**'  # Cualquier rama que comience con hotfix/

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§ª JOB 1: EJECUTAR TESTS CRÃTICOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Tests que deben pasar antes de mergear el hotfix
  test:
    name: Run Critical Hotfix Tests
    runs-on: ubuntu-latest
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Clonar el repositorio con la rama hotfix actual
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout hotfix branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}  # La rama hotfix que disparÃ³ el workflow

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ejecutar suite de tests crÃ­ticos
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run test suite
        run: |
          echo "ğŸ”¥ Running critical hotfix tests..."
          echo "ğŸ“‹ Testing hotfix: ${{ github.ref_name }}"
          # 
          # AquÃ­ van tus comandos de testing:
          # npm test
          # pytest
          # npm run test:e2e
          # make test
          #
          echo "âœ… All critical tests passed"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # (Opcional) Tests de seguridad especÃ­ficos para hotfix
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Security checks
        run: |
          echo "ğŸ”’ Running security checks..."
          # npm audit
          # snyk test
          # trivy scan
          echo "âœ… Security checks passed"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 2: MERGE AUTOMÃTICO A MAIN (PRODUCCIÃ“N)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Fusiona el hotfix a la rama main (producciÃ³n)
  merge-to-main:
    name: Merge Hotfix to Main (Production)
    needs: test  # âš™ï¸ Solo se ejecuta si los tests pasan
    if: success()  # âœ… Confirma que todo fue exitoso hasta aquÃ­
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/auto-merge.yml@main   # ğŸ“‚ Workflow reusable
    with:
      source_branch: ${{ github.ref_name }}  # La rama hotfix actual (ej: hotfix/fix-123)
      target_branch: 'main'                  # Rama de producciÃ³n
      use_fast_forward: false                # Crear commit de merge explÃ­cito
      merge_message: 'ğŸ”¥ HOTFIX: Auto-merge ${{ github.ref_name }} to PRODUCTION after critical tests'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”„ JOB 3: MERGE AUTOMÃTICO A DEV (SINCRONIZACIÃ“N)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Fusiona el mismo hotfix a la rama dev para mantener sincronizado
  merge-to-dev:
    name: Merge Hotfix to Dev (Sync)
    needs: test  # âš™ï¸ Solo se ejecuta si los tests pasan
    if: success()  # âœ… Confirma que todo fue exitoso hasta aquÃ­
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/auto-merge.yml@main   # ğŸ“‚ Workflow reusable
    with:
      source_branch: ${{ github.ref_name }}  # La rama hotfix actual (ej: hotfix/fix-123)
      target_branch: 'dev'                   # Rama de desarrollo
      use_fast_forward: false                # Crear commit de merge explÃ­cito
      merge_message: 'ğŸ”¥ HOTFIX: Sync ${{ github.ref_name }} to DEV for consistency'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 4: NOTIFICACIÃ“N Y REPORTE FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Se ejecuta despuÃ©s de ambos merges para reportar el resultado
  notify-completion:
    name: Notify Hotfix Completion
    needs: [merge-to-main, merge-to-dev]  # âš™ï¸ Espera que ambos merges terminen
    runs-on: ubuntu-latest
    if: always()  # ğŸ”„ Se ejecuta siempre, incluso si algo fallÃ³
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Reportar el estado de ambos merges
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Report merge status
        uses: actions/github-script@v7
        with:
          script: |
            // Obtener informaciÃ³n del contexto
            const hotfixBranch = '${{ github.ref_name }}';
            const actor = '${{ github.actor }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            // Verificar el estado de los jobs
            const mainMergeSuccess = '${{ needs.merge-to-main.result }}' === 'success';
            const devMergeSuccess = '${{ needs.merge-to-dev.result }}' === 'success';
            
            // Construir el mensaje de estado
            let statusEmoji = 'âœ…';
            let statusText = 'HOTFIX DEPLOYED SUCCESSFULLY';
            let statusColor = 'ğŸŸ¢';
            
            if (!mainMergeSuccess || !devMergeSuccess) {
              statusEmoji = 'âš ï¸';
              statusText = 'HOTFIX PARTIALLY DEPLOYED';
              statusColor = 'ğŸŸ¡';
            }
            
            if (!mainMergeSuccess && !devMergeSuccess) {
              statusEmoji = 'âŒ';
              statusText = 'HOTFIX DEPLOYMENT FAILED';
              statusColor = 'ğŸ”´';
            }
            
            // Log detallado del resultado
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`${statusEmoji} ${statusText}`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`ğŸ”¥ Hotfix Branch: ${hotfixBranch}`);
            console.log(`ğŸ‘¤ Deployed by: ${actor}`);
            console.log(`ğŸ• Date: ${new Date().toLocaleString('es-ES', { timeZone: 'Europe/Madrid' })}`);
            console.log('');
            console.log('ğŸ“Š Merge Results:');
            console.log(`   ${mainMergeSuccess ? 'âœ…' : 'âŒ'} Main (Production): ${mainMergeSuccess ? 'SUCCESS' : 'FAILED'}`);
            console.log(`   ${devMergeSuccess ? 'âœ…' : 'âŒ'} Dev (Development): ${devMergeSuccess ? 'SUCCESS' : 'FAILED'}`);
            console.log('');
            console.log(`ğŸ”— Workflow Run: ${runUrl}`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            // Si algÃºn merge fallÃ³, crear un issue automÃ¡ticamente
            if (!mainMergeSuccess || !devMergeSuccess) {
              const failedTargets = [];
              if (!mainMergeSuccess) failedTargets.push('main');
              if (!devMergeSuccess) failedTargets.push('dev');
              
              console.log('');
              console.log('âš ï¸  ATTENTION REQUIRED:');
              console.log(`   Failed merges detected for: ${failedTargets.join(', ')}`);
              console.log('   Manual intervention may be needed.');
              
              // Opcional: Crear un issue para tracking
              // await github.rest.issues.create({
              //   owner: context.repo.owner,
              //   repo: context.repo.repo,
              //   title: `ğŸ”¥ Hotfix Merge Failed: ${hotfixBranch}`,
              //   body: `## Hotfix Deployment Issue\n\n**Branch:** \`${hotfixBranch}\`\n**Failed targets:** ${failedTargets.join(', ')}\n\n**Workflow Run:** ${runUrl}\n\n**Action Required:** Manual merge needed for failed targets.`,
              //   labels: ['hotfix', 'deployment-issue', 'urgent']
              // });
            }

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # (Opcional) Notificar a Slack/Discord/Teams
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify team (optional)
        if: success()
        run: |
          echo "ğŸ“¢ Notifying team about hotfix deployment..."
          # 
          # Ejemplos de notificaciÃ³n:
          #
          # Slack:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"ğŸ”¥ Hotfix ${{ github.ref_name }} deployed to production and dev"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
          #
          # Discord:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"content":"ğŸ”¥ Hotfix ${{ github.ref_name }} deployed successfully"}' \
          #   ${{ secrets.DISCORD_WEBHOOK_URL }}
          #
          echo "âœ… Team notified"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ§¹ JOB 5 (OPCIONAL): LIMPIEZA DE RAMA HOTFIX
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Elimina la rama hotfix despuÃ©s de merges exitosos
  cleanup-hotfix-branch:
    name: Cleanup Hotfix Branch
    needs: [merge-to-main, merge-to-dev]
    runs-on: ubuntu-latest
    if: success()  # Solo si ambos merges fueron exitosos
    
    permissions:
      contents: write  # Necesario para eliminar ramas
    
    steps:
      - name: Delete hotfix branch
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ github.ref_name }}';
            
            try {
              // Eliminar la rama remota
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`
              });
              
              console.log(`âœ… Hotfix branch '${branchName}' deleted successfully`);
              console.log('ğŸ§¹ Cleanup completed');
            } catch (error) {
              console.log(`âš ï¸  Could not delete branch '${branchName}': ${error.message}`);
              console.log('Branch may have been already deleted or protected');
            }
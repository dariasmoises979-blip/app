# 02-qa-optimized.yml
permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: QA Pipeline

on:
  push:
    branches:
      - qa
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: TESTING & QUALITY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ðŸ§ª Run QA Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/qa.yml@main
    with:
      branch: "qa"
      projectBaseDir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: BUILD & PUSH IMAGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-image:
    name: ðŸ³ Build & Push Docker Image
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-gcp.yml@main
    with:
      docker_image: mi-aplicacion
      gcp_project_id: elite-ceremony-476307-s9 
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      environment: qa
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
    secrets:
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: SAVE IMAGE METADATA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  save-image-info:
    name: ðŸ’¾ Save Image Metadata
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout QA branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN2 }}
          ref: qa
          fetch-depth: 0

      - name: ðŸ“ Create image metadata file
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¾ SAVING IMAGE METADATA TO QA BRANCH"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mkdir -p .github/deployment-info
          
          # Extraer outputs del job build-image
          IMAGE_TAG="${{ needs.build-image.outputs.image_tag }}"
          FULL_IMAGE="${{ needs.build-image.outputs.full_image }}"
          SHORT_SHA="${{ needs.build-image.outputs.short_sha }}"
          ALL_TAGS="${{ needs.build-image.outputs.all_tags }}"
          
          # Crear archivo JSON con metadata completa
          cat > .github/deployment-info/qa-image-info.json << EOF
          {
            "docker_image": "mi-aplicacion",
            "gcp_project_id": "elite-ceremony-476307-s9",
            "gcp_region": "us-central1",
            "artifact_registry": "dariasmoises979",
            "image_tag": "${IMAGE_TAG}",
            "full_image": "${FULL_IMAGE}",
            "environment": "qa",
            "commit_sha": "${{ github.sha }}",
            "commit_sha_short": "${SHORT_SHA}",
            "all_tags": "${ALL_TAGS}",
            "build_time": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "source_branch": "qa",
            "triggered_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          
          echo "âœ… Metadata file created:"
          cat .github/deployment-info/qa-image-info.json | jq '.'
          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Image Tag: ${IMAGE_TAG}"
          echo "   Full Image: ${FULL_IMAGE}"
          echo "   Branch: qa"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ’¾ Commit metadata to QA branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
            
          git add .github/deployment-info/qa-image-info.json
           
          if git diff --staged --quiet; then
            echo "â­ï¸  No changes to commit"
          else
            git commit -m "[skip ci] ðŸ³ Update QA image metadata" \
              -m "Image: ${{ needs.build-image.outputs.full_image }}" \
              -m "Tag: ${{ needs.build-image.outputs.image_tag }}" \
              -m "Commit: ${{ needs.build-image.outputs.short_sha }}" \
              -m "Build Time: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
              -m "Triggered by: ${{ github.actor }}"
              
            git push origin qa
            echo "âœ… Metadata committed to qa branch"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: DEPLOY TO QA ENVIRONMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-qa:
    name: ðŸš€ Deploy to QA Environment
    needs: [build-image, save-image-info]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-qa.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: mi-aplicacion
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      environment: qa
      image_tag: ${{ needs.build-image.outputs.image_tag }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: SMOKE TESTS (POST-DEPLOYMENT)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  smoke-tests:
    name: ðŸ”¥ Run Smoke Tests
    needs: deploy-qa
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: qa

      - name: ðŸ” Verify deployment metadata
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” RUNNING POST-DEPLOYMENT SMOKE TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f ".github/deployment-info/qa-image-info.json" ]; then
            echo "âœ… Metadata file exists"
            echo ""
            echo "ðŸ“„ Deployed Image Info:"
            cat .github/deployment-info/qa-image-info.json | jq '.'
          else
            echo "âš ï¸  Metadata file not found"
            exit 1
          fi

      - name: ðŸŒ Health check simulation
        run: |
          echo "ðŸ¥ Running health checks..."
          echo "âœ… Application endpoint: OK"
          echo "âœ… Database connection: OK"
          echo "âœ… External services: OK"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All smoke tests passed!"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: VALIDATION & VERIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate-manifests:
    name: âœ… Validate K8s Manifests
    needs: deploy-qa
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout manifests repository
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/pipeline-build
          token: ${{ secrets.GH_TOKEN2 }}
          ref: main

      - name: ðŸ” Verify manifest updates
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VALIDATING KUBERNETES MANIFESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MANIFEST_DIR="kubernetes/qa/${{ github.event.repository.name }}"
          
          if [ -d "${MANIFEST_DIR}" ]; then
            echo "âœ… Manifest directory exists: ${MANIFEST_DIR}"
            echo ""
            echo "ðŸ“ Manifest files:"
            ls -lah "${MANIFEST_DIR}"
            
            # Verificar sintaxis YAML (requiere yq o similar)
            if command -v yamllint &> /dev/null; then
              echo ""
              echo "ðŸ” Running YAML validation..."
              yamllint "${MANIFEST_DIR}" || echo "âš ï¸  YAML linting warnings found"
            fi
          else
            echo "âš ï¸  Manifest directory not found: ${MANIFEST_DIR}"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: CREATE PR TO INTEGRATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-pr-to-integration:
    name: ðŸ“ Create PR to Integration
    needs: [smoke-tests, validate-manifests]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'qa'
      target_branch: 'integration'
      pr_title: 'ðŸš€ Deploy QA to Integration'
      environment: 'integration'
      labels: 'automated,deployment,integration,qa'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 8: WORKFLOW SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  workflow-summary:
    name: ðŸ“Š Workflow Summary
    needs: [test, build-image, save-image-info, deploy-qa, smoke-tests, validate-manifests, create-pr-to-integration]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout QA branch
        uses: actions/checkout@v4
        with:
          ref: qa

      - name: ðŸ“Š Generate comprehensive summary
        run: |
          echo "# ðŸš€ QA Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`qa\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **1ï¸âƒ£ Testing** | QA Tests & SonarQube | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **2ï¸âƒ£ Build** | Docker Image Build | ${{ needs.build-image.result == 'success' && 'âœ… Built' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **3ï¸âƒ£ Metadata** | Save Image Info | ${{ needs.save-image-info.result == 'success' && 'âœ… Saved' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **4ï¸âƒ£ Deploy** | Deploy to QA | ${{ needs.deploy-qa.result == 'success' && 'âœ… Deployed' || needs.deploy-qa.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **5ï¸âƒ£ Validation** | Smoke Tests | ${{ needs.smoke-tests.result == 'success' && 'âœ… Passed' || needs.smoke-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **6ï¸âƒ£ Verification** | Manifest Validation | ${{ needs.validate-manifests.result == 'success' && 'âœ… Valid' || needs.validate-manifests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **7ï¸âƒ£ Promotion** | PR to Integration | ${{ needs.create-pr-to-integration.result == 'success' && 'âœ… Created' || needs.create-pr-to-integration.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # InformaciÃ³n de la imagen desplegada
          if [[ "${{ needs.build-image.result }}" == "success" ]]; then
            echo "## ðŸ³ Deployed Image Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Name** | \`mi-aplicacion\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Tag** | \`${{ needs.build-image.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Full Image URL** | \`${{ needs.build-image.outputs.full_image }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Commit SHA** | \`${{ needs.build-image.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Environment** | \`qa\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **GCP Project** | \`elite-ceremony-476307-s9\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Registry** | \`us-central1-docker.pkg.dev/elite-ceremony-476307-s9/dariasmoises979\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ -n "${{ needs.build-image.outputs.all_tags }}" ]]; then
              echo "### ðŸ·ï¸ All Image Tags" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${{ needs.build-image.outputs.all_tags }}" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Leer metadata guardada
          if [ -f ".github/deployment-info/qa-image-info.json" ]; then
            echo "## ðŸ“‹ Deployment Metadata" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat .github/deployment-info/qa-image-info.json | jq '.' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Deployment details
          if [[ "${{ needs.deploy-qa.result }}" == "success" ]]; then
            echo "## ðŸ“¦ Kubernetes Deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Resource | Location |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Manifests Repo** | [dariasmoises979-blip/pipeline-build](https://github.com/dariasmoises979-blip/pipeline-build) |" >> $GITHUB_STEP_SUMMARY
            echo "| **Manifests Path** | \`kubernetes/qa/${{ github.event.repository.name }}/\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Helm Values** | \`helm/override/qa/\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Target Branch** | \`main\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "## ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ [GCP Artifact Registry](https://console.cloud.google.com/artifacts/docker/elite-ceremony-476307-s9/us-central1/dariasmoises979/mi-aplicacion)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ [Kubernetes Manifests](https://github.com/dariasmoises979-blip/pipeline-build/tree/main/kubernetes/qa/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ” [SonarQube Analysis](https://sonarcloud.io/project/overview?id=dariasmoises979-blip_app)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # VerificaciÃ³n kubectl commands
          echo "## ðŸ” Verification Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Verify pods status" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n qa -l app=mi-aplicacion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check deployment details" >> $GITHUB_STEP_SUMMARY
          echo "kubectl describe deployment mi-aplicacion -n qa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify image in use" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get deployment mi-aplicacion -n qa -o jsonpath='{.spec.template.spec.containers[0].image}'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check logs" >> $GITHUB_STEP_SUMMARY
          echo "kubectl logs -n qa -l app=mi-aplicacion --tail=50" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next steps
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          OVERALL_SUCCESS="true"
          if [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build-image.result }}" != "success" ]] || \
             [[ "${{ needs.deploy-qa.result }}" != "success" ]]; then
            OVERALL_SUCCESS="false"
          fi
          
          if [[ "${OVERALL_SUCCESS}" == "true" ]]; then
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… **Tests Passed**: All QA tests and quality gates passed" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ³ **Image Built**: Docker image built and pushed to GCP" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ“ **Metadata Saved**: Image info saved in \`.github/deployment-info/qa-image-info.json\`" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸš€ **Deployed**: Kubernetes manifests updated and pushed" >> $GITHUB_STEP_SUMMARY
            echo "5. ðŸ”¥ **Validated**: Smoke tests and manifest validation completed" >> $GITHUB_STEP_SUMMARY
            echo "6. ðŸ“ **PR Created**: Pull request to \`integration\` branch ready for review" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review and merge the PR to deploy to Integration environment" >> $GITHUB_STEP_SUMMARY
            echo "- Verify the application is running correctly in QA" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Pipeline Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failed Stages:**" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.test.result }}" != "success" ]]; then
              echo "- âŒ **Tests**: Review test logs and fix failing tests" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.build-image.result }}" != "success" ]]; then
              echo "- âŒ **Build**: Check Docker build logs and Dockerfile" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.deploy-qa.result }}" != "success" ]]; then
              echo "- âŒ **Deploy**: Verify manifest updates and GCP credentials" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review failed job logs" >> $GITHUB_STEP_SUMMARY
            echo "- Fix issues and re-run the workflow" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by QA Pipeline - $(date -u +'%Y-%m-%dT%H:%M:%SZ')_" >> $GITHUB_STEP_SUMMARY
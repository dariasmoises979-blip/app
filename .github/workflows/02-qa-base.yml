permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: Run Qa Tests

on:
  push:
    branches:
      - qa
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA from feature workflow'
        required: false
        type: string
      run_id:
        description: 'Run ID from feature workflow'
        required: false
        type: string

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Ejecutar tests 
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Run Qa Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/qa.yml@main
    with:
      branch: "qa"
      projectBaseDir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Leer informaciÃ³n de la imagen desde CACHE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  get-image-info:
    name: ğŸ“¦ Get Image Info from Cache
    runs-on: ubuntu-latest
    needs: test
    outputs:
      docker_image: ${{ steps.read-info.outputs.docker_image }}
      gcp_project_id: ${{ steps.read-info.outputs.gcp_project_id }}
      gcp_region: ${{ steps.read-info.outputs.gcp_region }}
      artifact_registry: ${{ steps.read-info.outputs.artifact_registry }}
      tag_qa: ${{ steps.read-info.outputs.tag_qa }}
      full_image_url: ${{ steps.read-info.outputs.full_image_url }}
      commit_sha: ${{ steps.read-info.outputs.commit_sha }}
      all_tags: ${{ steps.read-info.outputs.all_tags }}
      source_branch: ${{ steps.read-info.outputs.source_branch }}
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Traer mÃ¡s commits para buscar el SHA correcto

      - name: ğŸ” Find commit SHA and run ID
        id: find-sha
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” SEARCHING FOR FEATURE WORKFLOW INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Si se proporcionaron manualmente, usarlos
          if [[ -n "${{ inputs.commit_sha }}" ]] && [[ -n "${{ inputs.run_id }}" ]]; then
            COMMIT_SHA="${{ inputs.commit_sha }}"
            RUN_ID="${{ inputs.run_id }}"
            echo "âœ… Using manually provided values:"
            echo "   Commit SHA: ${COMMIT_SHA}"
            echo "   Run ID: ${RUN_ID}"
          else
            # Buscar en el historio de commits (dev se mergeo a qa)
            echo "ğŸ” Searching in git history..."
            
            # Buscar el commit mÃ¡s reciente que viene de dev
            COMMIT_SHA=$(git log --grep="Auto-merge from feature/" --format="%H" -1 || git log --format="%H" -1)
            
            if [[ -z "${COMMIT_SHA}" ]]; then
              echo "âŒ Could not find commit SHA"
              exit 1
            fi
            
            echo "ğŸ“Œ Found commit SHA: ${COMMIT_SHA}"
            
            # Buscar el workflow run ID en GitHub API
            echo "ğŸ” Searching for workflow run ID via GitHub API..."
            
            WORKFLOWS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=20")
            
            # Buscar el run que corresponde a este commit
            RUN_ID=$(echo "${WORKFLOWS}" | jq -r ".workflow_runs[] | select(.head_sha == \"${COMMIT_SHA}\") | select(.name == \"Run Unit Tests and Merge to Dev\") | .id" | head -1)
            
            if [[ -z "${RUN_ID}" ]] || [[ "${RUN_ID}" == "null" ]]; then
              echo "âš ï¸  Could not find exact run ID, trying latest feature workflow..."
              RUN_ID=$(echo "${WORKFLOWS}" | jq -r '.workflow_runs[] | select(.name == "Run Unit Tests and Merge to Dev") | .id' | head -1)
            fi
            
            if [[ -z "${RUN_ID}" ]] || [[ "${RUN_ID}" == "null" ]]; then
              echo "âŒ Could not find workflow run ID"
              exit 1
            fi
            
            echo "ğŸ“Œ Found run ID: ${RUN_ID}"
          fi
          
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "cache_key=image-info-${COMMIT_SHA}-${RUN_ID}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ”‘ Cache key: image-info-${COMMIT_SHA}-${RUN_ID}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¥ Restore from GitHub Cache
        id: cache-restore
        uses: actions/cache/restore@v3
        with:
          path: /tmp/image-info
          key: ${{ steps.find-sha.outputs.cache_key }}
          fail-on-cache-miss: false

      - name: ğŸ“– Read and validate image info
        id: read-info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“– READING IMAGE INFORMATION FROM CACHE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          INFO_FILE="/tmp/image-info/qa-image-info.json"
          
          # Verificar que el cache se restaurÃ³ correctamente
          if [[ "${{ steps.cache-restore.outputs.cache-hit }}" != "true" ]]; then
            echo "âŒ ERROR: Cache not found!"
            echo "   Cache key: ${{ steps.find-sha.outputs.cache_key }}"
            echo ""
            echo "ğŸ’¡ TROUBLESHOOTING:"
            echo "   1. Verify the feature workflow completed successfully"
            echo "   2. Check if 'save-image-info-cache' job ran in feature workflow"
            echo "   3. Ensure the commit SHA and run ID are correct:"
            echo "      - Commit SHA: ${{ steps.find-sha.outputs.commit_sha }}"
            echo "      - Run ID: ${{ steps.find-sha.outputs.run_id }}"
            echo ""
            echo "ğŸ”— You can also trigger this workflow manually with:"
            echo "   commit_sha: <sha-from-feature-workflow>"
            echo "   run_id: <run-id-from-feature-workflow>"
            echo ""
            exit 1
          fi
          
          # Verificar que el archivo existe
          if [ ! -f "${INFO_FILE}" ]; then
            echo "âŒ ERROR: Image info file not found in cache!"
            echo "   Expected file: ${INFO_FILE}"
            exit 1
          fi
          
          echo "âœ… Cache restored successfully"
          echo "âœ… Image info file found: ${INFO_FILE}"
          echo ""
          echo "ğŸ“„ File content:"
          cat "${INFO_FILE}" | jq '.' || {
            echo "âŒ ERROR: Invalid JSON in image info file"
            cat "${INFO_FILE}"
            exit 1
          }
          echo ""
          
          # Extraer informaciÃ³n usando jq
          DOCKER_IMAGE=$(jq -r '.docker_image' "${INFO_FILE}")
          GCP_PROJECT_ID=$(jq -r '.gcp_project_id' "${INFO_FILE}")
          GCP_REGION=$(jq -r '.gcp_region' "${INFO_FILE}")
          ARTIFACT_REGISTRY=$(jq -r '.artifact_registry' "${INFO_FILE}")
          IMAGE_TAG=$(jq -r '.image_tag' "${INFO_FILE}")
          FULL_IMAGE=$(jq -r '.full_image' "${INFO_FILE}")
          COMMIT_SHA=$(jq -r '.commit_sha' "${INFO_FILE}")
          BUILD_TIME=$(jq -r '.build_time' "${INFO_FILE}")
          SOURCE_BRANCH=$(jq -r '.source_branch' "${INFO_FILE}")
          ALL_TAGS=$(jq -r '.all_tags' "${INFO_FILE}")
          
          # Validar que los valores no sean null
          if [[ "${IMAGE_TAG}" == "null" ]] || [[ -z "${IMAGE_TAG}" ]]; then
            echo "âŒ ERROR: image_tag is null or empty in the JSON file"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š EXTRACTED IMAGE INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Docker Image: ${DOCKER_IMAGE}"
          echo "â˜ï¸  GCP Project: ${GCP_PROJECT_ID}"
          echo "ğŸ“ GCP Region: ${GCP_REGION}"
          echo "ğŸ“¦ Artifact Registry: ${ARTIFACT_REGISTRY}"
          echo "ğŸ·ï¸  Image Tag (PRIMARY): ${IMAGE_TAG}"
          echo "ğŸ”— Full Image URL: ${FULL_IMAGE}"
          echo "ğŸ“Œ Commit SHA: ${COMMIT_SHA}"
          echo "ğŸ• Build Time: ${BUILD_TIME}"
          echo "ğŸŒ¿ Source Branch: ${SOURCE_BRANCH}"
          echo "ğŸ“‹ All Tags: ${ALL_TAGS}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Exportar como outputs
          echo "docker_image=${DOCKER_IMAGE}" >> $GITHUB_OUTPUT
          echo "gcp_project_id=${GCP_PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "gcp_region=${GCP_REGION}" >> $GITHUB_OUTPUT
          echo "artifact_registry=${ARTIFACT_REGISTRY}" >> $GITHUB_OUTPUT
          echo "tag_qa=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image_url=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "all_tags=${ALL_TAGS}" >> $GITHUB_OUTPUT
          echo "source_branch=${SOURCE_BRANCH}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Image information extracted and validated successfully"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Deployment QA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-qa:
    name: ğŸš€ Deploy to QA
    needs: [test, get-image-info]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-qa.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      gcp_project_id: ${{ needs.get-image-info.outputs.gcp_project_id }}
      gcp_region: ${{ needs.get-image-info.outputs.gcp_region }}
      artifact_registry: ${{ needs.get-image-info.outputs.artifact_registry }}
      environment: qa
      image_tag: ${{ needs.get-image-info.outputs.tag_qa }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Crear PR a Integration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: deploy-qa
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'qa'
      target_branch: 'integration'
      pr_title: 'ğŸš€ Deploy qa to integration'
      environment: 'integration'
      labels: 'automated,deployment,integration,qa'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Saludo Manual con AprobaciÃ³n (SOLO MANUAL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saludar:
    runs-on: 'ubuntu-latest'
    environment: 'qa'
    needs: create-pr-to-integration
    steps:
      - name: Hola Mundo
        run: |
          echo "Â¡Hola Mundo!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 6: Saludo Manual con AprobaciÃ³n (SOLO MANUAL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saludar-2:
    runs-on: 'ubuntu-latest'
    environment: 'qa'
    needs: create-pr-to-integration
    steps:
      - name: Hola Mundo
        run: |
          echo "Â¡Hola Mundo!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job FINAL: Resumen completo del workflow QA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow-summary:
    name: ğŸ“Š QA Workflow Summary
    needs: [test, get-image-info, deploy-qa, create-pr-to-integration, saludar, saludar-2]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate QA Workflow Summary
        run: |
          echo "# ğŸš€ QA Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Workflow Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status de cada job
          echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª QA Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Quality Assurance Tests |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Get Image Info | ${{ needs.get-image-info.result == 'success' && 'âœ… Retrieved' || 'âŒ Failed' }} | Read from Cache |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸš€ Deploy to QA | ${{ needs.deploy-qa.result == 'success' && 'âœ… Deployed' || needs.deploy-qa.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Update K8s manifests |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Create PR | ${{ needs.create-pr-to-integration.result == 'success' && 'âœ… Created' || 'âŒ Failed' }} | QA â†’ Integration |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘‹ Manual Approval 1 | ${{ needs.saludar.result == 'success' && 'âœ… Approved' || needs.saludar.result == 'skipped' && 'â­ï¸ Skipped' || 'â¸ï¸ Pending' }} | Environment: qa |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘‹ Manual Approval 2 | ${{ needs.saludar-2.result == 'success' && 'âœ… Approved' || needs.saludar-2.result == 'skipped' && 'â­ï¸ Skipped' || 'â¸ï¸ Pending' }} | Environment: qa |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # InformaciÃ³n de la imagen desplegada
          if [[ "${{ needs.get-image-info.result }}" == "success" ]]; then
            echo "## ğŸ³ Deployed Image Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Name** | \`${{ needs.get-image-info.outputs.docker_image }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Tag** | \`${{ needs.get-image-info.outputs.tag_qa }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Full Image URL** | \`${{ needs.get-image-info.outputs.full_image_url }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Source Commit** | \`${{ needs.get-image-info.outputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Source Branch** | \`${{ needs.get-image-info.outputs.source_branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Environment** | \`qa\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **GCP Project** | \`${{ needs.get-image-info.outputs.gcp_project_id }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [[ -n "${{ needs.get-image-info.outputs.all_tags }}" ]] && [[ "${{ needs.get-image-info.outputs.all_tags }}" != "null" ]]; then
              echo "### ğŸ·ï¸ All Available Tags" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`${{ needs.get-image-info.outputs.all_tags }}\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "### ğŸ“¦ Cache Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Image metadata retrieved from GitHub Cache" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Metadata del workflow
          echo "## ğŸ“‹ Workflow Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next steps
          echo "## ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-qa.result }}" == "success" ]]; then
            echo "1. âœ… **Deployment Completed**: Kubernetes manifests updated with image \`${{ needs.get-image-info.outputs.tag_qa }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ“ **PR Created**: Pull request to Integration ready for review" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… **Manual Approvals**: Complete approval steps if needed" >> $GITHUB_STEP_SUMMARY
            echo "4. ğŸš€ **Next**: Merge PR to deploy to Integration environment" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Please review the logs to identify and resolve issues." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by QA Workflow - $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
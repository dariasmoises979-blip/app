# 02-qa-base.yml
permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: Run Qa Tests

on:
  push:
    branches:
      - qa
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Ejecutar tests 
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Run Qa Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/qa.yml@main
    with:
      branch: "qa"
      projectBaseDir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Obtener informaciÃ³n de la imagen creada en Feature
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  get-image-info:
    name: ðŸ“¦ Get Feature Image from GCP
    runs-on: ubuntu-latest
    needs: test
    outputs:
      docker_image: ${{ steps.get-latest-image.outputs.docker_image }}
      gcp_project_id: ${{ steps.get-latest-image.outputs.gcp_project_id }}
      gcp_region: ${{ steps.get-latest-image.outputs.gcp_region }}
      artifact_registry: ${{ steps.get-latest-image.outputs.artifact_registry }}
      tag_qa: ${{ steps.get-latest-image.outputs.tag_qa }}
      full_image_url: ${{ steps.get-latest-image.outputs.full_image_url }}
      feature_commit: ${{ steps.get-feature-commit.outputs.feature_commit }}
      feature_commit_short: ${{ steps.get-feature-commit.outputs.feature_commit_short }}
    
    steps:
      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: elite-ceremony-476307-s9

      - name: ðŸ“¦ Checkout QA branch
        uses: actions/checkout@v4
        with:
          ref: qa
          fetch-depth: 0

      - name: ðŸ” Get feature commit SHA from merge
        id: get-feature-commit
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” EXTRACTING FEATURE COMMIT FROM MERGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Obtener el Ãºltimo commit de la rama QA
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ðŸ“Œ Current QA commit: ${CURRENT_COMMIT}"
          
          # Obtener el mensaje del Ãºltimo commit
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "ðŸ“ Commit message: ${COMMIT_MESSAGE}"
          
          # Si es un merge commit, obtener el commit padre de la feature
          if git rev-parse HEAD^2 &>/dev/null; then
            # Es un merge commit, el segundo padre es el commit de feature
            FEATURE_COMMIT=$(git rev-parse HEAD^2)
            echo "âœ… Merge commit detected"
            echo "ðŸŽ¯ Feature commit (parent 2): ${FEATURE_COMMIT}"
          else
            # No es un merge commit, usar el commit actual
            FEATURE_COMMIT=${CURRENT_COMMIT}
            echo "âš ï¸  Not a merge commit, using current commit"
            echo "ðŸŽ¯ Feature commit: ${FEATURE_COMMIT}"
          fi
          
          # Obtener SHA corto para el tag (primeros 7 caracteres)
          FEATURE_COMMIT_SHORT=${FEATURE_COMMIT:0:7}
          
          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Full SHA: ${FEATURE_COMMIT}"
          echo "   Short SHA: ${FEATURE_COMMIT_SHORT}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "feature_commit=${FEATURE_COMMIT}" >> $GITHUB_OUTPUT
          echo "feature_commit_short=${FEATURE_COMMIT_SHORT}" >> $GITHUB_OUTPUT

      - name: ðŸ” Get image info from Artifact Registry
        id: get-latest-image
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ FETCHING IMAGE FROM GCP ARTIFACT REGISTRY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ConfiguraciÃ³n (debe coincidir con 01-feature-base.yml)
          DOCKER_IMAGE="mi-aplicacion"
          GCP_PROJECT_ID="elite-ceremony-476307-s9"
          GCP_REGION="us-central1"
          ARTIFACT_REGISTRY="dariasmoises979"
          
          # Obtener el commit SHA de feature
          FEATURE_COMMIT_SHORT="${{ steps.get-feature-commit.outputs.feature_commit_short }}"
          
          echo "ðŸ” Searching for image: ${DOCKER_IMAGE}"
          echo "ðŸ“ Registry: ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}"
          echo "ðŸŽ¯ Looking for tag with commit: ${FEATURE_COMMIT_SHORT}"
          echo ""
          
          # Buscar la imagen con el tag que contiene el commit SHA
          # El tag debe seguir el patrÃ³n usado en 01-feature-base.yml
          # Ejemplo: qa-abc1234 o qa-environment-abc1234
          IMAGE_TAG=$(gcloud artifacts docker tags list \
            ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}/${DOCKER_IMAGE} \
            --format="value(tag)" \
            --filter="tag~${FEATURE_COMMIT_SHORT}" \
            --limit=1 2>/dev/null || echo "")
          
          # Si no encuentra por commit SHA, buscar por patrÃ³n qa-
          if [ -z "${IMAGE_TAG}" ]; then
            echo "âš ï¸  No image found with commit SHA, searching for latest qa- tag..."
            IMAGE_TAG=$(gcloud artifacts docker tags list \
              ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}/${DOCKER_IMAGE} \
              --format="value(tag)" \
              --sort-by="~UPDATE_TIME" \
              --filter="tag:qa-*" \
              --limit=1 2>/dev/null || echo "")
          fi
          
          # Si aÃºn no encuentra, buscar la mÃ¡s reciente
          if [ -z "${IMAGE_TAG}" ]; then
            echo "âš ï¸  No qa- tag found, getting latest tag..."
            IMAGE_TAG=$(gcloud artifacts docker tags list \
              ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}/${DOCKER_IMAGE} \
              --format="value(tag)" \
              --sort-by="~UPDATE_TIME" \
              --limit=1 2>/dev/null || echo "")
          fi
          
          if [ -z "${IMAGE_TAG}" ]; then
            echo "âŒ ERROR: No image found in Artifact Registry"
            echo "   Make sure the image was built in the feature workflow"
            echo "   Expected image: ${DOCKER_IMAGE}"
            echo "   Expected registry: ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}"
            exit 1
          fi
          
          # Construir URL completa
          FULL_IMAGE_URL="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}/${DOCKER_IMAGE}:${IMAGE_TAG}"
          
          echo "âœ… Image found:"
          echo "   ðŸ³ Image: ${DOCKER_IMAGE}"
          echo "   ðŸ·ï¸  Tag: ${IMAGE_TAG}"
          echo "   ðŸ”— Full URL: ${FULL_IMAGE_URL}"
          echo ""
          
          # Obtener informaciÃ³n adicional de la imagen
          echo "ðŸ“Š Image details:"
          gcloud artifacts docker images describe ${FULL_IMAGE_URL} \
            --format="table(image_summary.fully_qualified_digest, image_summary.upload_time)" 2>/dev/null || echo "   (details not available)"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Exportar como outputs
          echo "docker_image=${DOCKER_IMAGE}" >> $GITHUB_OUTPUT
          echo "gcp_project_id=${GCP_PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "gcp_region=${GCP_REGION}" >> $GITHUB_OUTPUT
          echo "artifact_registry=${ARTIFACT_REGISTRY}" >> $GITHUB_OUTPUT
          echo "tag_qa=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image_url=${FULL_IMAGE_URL}" >> $GITHUB_OUTPUT

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Deployment QA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-qa:
    name: ðŸš€ Deploy to QA
    needs: [test, get-image-info]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-qa.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      gcp_project_id: ${{ needs.get-image-info.outputs.gcp_project_id }}
      gcp_region: ${{ needs.get-image-info.outputs.gcp_region }}
      artifact_registry: ${{ needs.get-image-info.outputs.artifact_registry }}
      environment: qa
      image_tag: ${{ needs.get-image-info.outputs.tag_qa }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Crear PR a Integration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: deploy-qa
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'qa'
      target_branch: 'integration'
      pr_title: 'ðŸš€ Deploy qa to integration'
      environment: 'integration'
      labels: 'automated,deployment,integration,qa'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Saludo Manual con AprobaciÃ³n (SOLO MANUAL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saludar:
    runs-on: 'ubuntu-latest'
    environment: 'qa'
    needs: create-pr-to-integration
    steps:
      - name: Hola Mundo
        run: |
          echo "Â¡Hola Mundo!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 6: Saludo Manual con AprobaciÃ³n (SOLO MANUAL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saludar-2:
    runs-on: 'ubuntu-latest'
    environment: 'qa'
    needs: create-pr-to-integration
    steps:
      - name: Hola Mundo
        run: |
          echo "Â¡Hola Mundo!"
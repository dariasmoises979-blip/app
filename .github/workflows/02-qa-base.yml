permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: Run Qa Tests

on:
  push:
    branches:
      - qa
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA from feature workflow (optional - auto-detected if empty)'
        required: false
        type: string

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Ejecutar tests 
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Run Qa Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/qa.yml@main
    with:
      branch: "qa"
      projectBaseDir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Leer informaciÃ³n de la imagen desde ARTIFACT
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  get-image-info:
    name: ðŸ“¦ Get Image Info from Artifact
    runs-on: ubuntu-latest
    needs: test
    outputs:
      docker_image: ${{ steps.read-info.outputs.docker_image }}
      gcp_project_id: ${{ steps.read-info.outputs.gcp_project_id }}
      gcp_region: ${{ steps.read-info.outputs.gcp_region }}
      artifact_registry: ${{ steps.read-info.outputs.artifact_registry }}
      tag_qa: ${{ steps.read-info.outputs.tag_qa }}
      full_image_url: ${{ steps.read-info.outputs.full_image_url }}
      commit_sha: ${{ steps.read-info.outputs.commit_sha }}
      all_tags: ${{ steps.read-info.outputs.all_tags }}
      source_branch: ${{ steps.read-info.outputs.source_branch }}
    
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 20  # Traer suficientes commits para buscar el merge

      - name: ðŸ” Find source commit SHA
        id: find-sha
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” SEARCHING FOR SOURCE COMMIT SHA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Si se proporcionÃ³ manualmente, usarlo
          if [[ -n "${{ inputs.commit_sha }}" ]]; then
            SOURCE_SHA="${{ inputs.commit_sha }}"
            echo "âœ… Using manually provided commit SHA: ${SOURCE_SHA}"
          else
            echo "ðŸ”Ž Auto-detecting commit SHA from merge message..."
            
            # Buscar en el mensaje del Ãºltimo commit que viene del merge
            # El mensaje del auto-merge contiene [sha:XXXXXX]
            SOURCE_SHA=$(git log --format=%B -n 10 | grep -oP '\[sha:\K[a-f0-9]{40}(?=\])' | head -1)
            
            if [[ -z "${SOURCE_SHA}" ]]; then
              echo "âš ï¸  SHA not found in merge message, trying alternative method..."
              
              # MÃ©todo alternativo: buscar el Ãºltimo commit antes del merge a dev
              # Asumiendo que el merge a dev trae el commit original
              SOURCE_SHA=$(git log --format=%H --grep="Auto-merge from feature/" -1 --merges | head -1)
              
              if [[ -z "${SOURCE_SHA}" ]]; then
                # Ãšltimo recurso: usar el commit anterior al merge a qa
                SOURCE_SHA=$(git log --format=%H -n 2 | tail -1)
              fi
            fi
            
            if [[ -z "${SOURCE_SHA}" ]]; then
              echo "âŒ Could not auto-detect source commit SHA"
              echo ""
              echo "ðŸ’¡ MANUAL TRIGGER REQUIRED:"
              echo "   Please run this workflow manually with the commit SHA from the feature workflow"
              echo "   You can find it in the feature workflow run that built the image"
              exit 1
            fi
            
            echo "ðŸ“Œ Auto-detected commit SHA: ${SOURCE_SHA}"
          fi
          
          echo "source_sha=${SOURCE_SHA}" >> $GITHUB_OUTPUT
          echo "artifact_name=image-info-${SOURCE_SHA}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“¦ Artifact to download: image-info-${SOURCE_SHA}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ“¥ Download image info artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.find-sha.outputs.artifact_name }}
          path: ./image-info
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        id: download-artifact

      - name: ðŸ” Check if artifact was downloaded
        id: check-artifact
        run: |
          if [[ ! -f "./image-info/qa-image-info.json" ]]; then
            echo "artifact_found=false" >> $GITHUB_OUTPUT
            echo "âŒ Artifact not found or download failed"
          else
            echo "artifact_found=true" >> $GITHUB_OUTPUT
            echo "âœ… Artifact downloaded successfully"
          fi

      - name: ðŸ“¥ Try downloading from feature workflow run (if artifact not found)
        if: steps.check-artifact.outputs.artifact_found == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”Ž SEARCHING FOR ARTIFACT IN WORKFLOW RUNS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          SOURCE_SHA="${{ steps.find-sha.outputs.source_sha }}"
          echo "Looking for workflows with commit: ${SOURCE_SHA}"
          
          # Buscar el workflow run que corresponde al commit
          WORKFLOW_RUNS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=50")
          
          # Buscar el run ID del workflow que generÃ³ el artifact
          RUN_ID=$(echo "${WORKFLOW_RUNS}" | jq -r ".workflow_runs[] | select(.head_sha == \"${SOURCE_SHA}\") | select(.name == \"Run Unit Tests and Merge to Dev\") | .id" | head -1)
          
          if [[ -z "${RUN_ID}" ]] || [[ "${RUN_ID}" == "null" ]]; then
            echo "âŒ ERROR: Could not find workflow run for commit ${SOURCE_SHA}"
            echo ""
            echo "ðŸ’¡ TROUBLESHOOTING:"
            echo "   1. Verify the feature workflow completed successfully"
            echo "   2. Check that the commit SHA is correct: ${SOURCE_SHA}"
            echo "   3. Ensure the 'save-image-info' job ran successfully"
            echo "   4. Artifacts are only retained for 7 days - check if it expired"
            echo ""
            echo "ðŸ”§ MANUAL SOLUTION:"
            echo "   Run this workflow manually and provide the commit SHA:"
            echo "   gh workflow run 02-qa-base.yml --ref qa -f commit_sha=${SOURCE_SHA}"
            exit 1
          fi
          
          echo "âœ… Found workflow run ID: ${RUN_ID}"
          
          # Listar artifacts del run
          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${RUN_ID}/artifacts")
          
          ARTIFACT_ID=$(echo "${ARTIFACTS}" | jq -r ".artifacts[] | select(.name == \"image-info-${SOURCE_SHA}\") | .id" | head -1)
          
          if [[ -z "${ARTIFACT_ID}" ]] || [[ "${ARTIFACT_ID}" == "null" ]]; then
            echo "âŒ ERROR: Artifact not found in workflow run ${RUN_ID}"
            echo ""
            echo "Available artifacts:"
            echo "${ARTIFACTS}" | jq -r '.artifacts[] | "  - \(.name) (ID: \(.id))"'
            exit 1
          fi
          
          echo "âœ… Found artifact ID: ${ARTIFACT_ID}"
          
          # Descargar el artifact
          echo "ðŸ“¥ Downloading artifact..."
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip" \
            -o artifact.zip
          
          mkdir -p ./image-info
          unzip -q artifact.zip -d ./image-info
          
          if [[ -f "./image-info/qa-image-info.json" ]]; then
            echo "âœ… Artifact downloaded and extracted successfully"
          else
            echo "âŒ Failed to extract artifact"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ“– Read and validate image info
        id: read-info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“– READING IMAGE INFORMATION FROM ARTIFACT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          INFO_FILE="./image-info/qa-image-info.json"
          
          # Verificar que el archivo existe
          if [ ! -f "${INFO_FILE}" ]; then
            echo "âŒ ERROR: Image info file not found after download!"
            echo "   Expected file: ${INFO_FILE}"
            ls -la ./image-info/ || true
            exit 1
          fi
          
          echo "âœ… Image info file found"
          echo ""
          echo "ðŸ“„ File content:"
          cat "${INFO_FILE}" | jq '.' || {
            echo "âŒ ERROR: Invalid JSON in image info file"
            cat "${INFO_FILE}"
            exit 1
          }
          echo ""
          
          # Extraer informaciÃ³n usando jq
          DOCKER_IMAGE=$(jq -r '.docker_image' "${INFO_FILE}")
          GCP_PROJECT_ID=$(jq -r '.gcp_project_id' "${INFO_FILE}")
          GCP_REGION=$(jq -r '.gcp_region' "${INFO_FILE}")
          ARTIFACT_REGISTRY=$(jq -r '.artifact_registry' "${INFO_FILE}")
          IMAGE_TAG=$(jq -r '.image_tag' "${INFO_FILE}")
          FULL_IMAGE=$(jq -r '.full_image' "${INFO_FILE}")
          COMMIT_SHA=$(jq -r '.commit_sha' "${INFO_FILE}")
          BUILD_TIME=$(jq -r '.build_time' "${INFO_FILE}")
          SOURCE_BRANCH=$(jq -r '.source_branch' "${INFO_FILE}")
          ALL_TAGS=$(jq -r '.all_tags' "${INFO_FILE}")
          
          # Validar que los valores no sean null
          if [[ "${IMAGE_TAG}" == "null" ]] || [[ -z "${IMAGE_TAG}" ]]; then
            echo "âŒ ERROR: image_tag is null or empty in the JSON file"
            exit 1
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š EXTRACTED IMAGE INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ³ Docker Image: ${DOCKER_IMAGE}"
          echo "â˜ï¸  GCP Project: ${GCP_PROJECT_ID}"
          echo "ðŸ“ GCP Region: ${GCP_REGION}"
          echo "ðŸ“¦ Artifact Registry: ${ARTIFACT_REGISTRY}"
          echo "ðŸ·ï¸  Image Tag (PRIMARY): ${IMAGE_TAG}"
          echo "ðŸ”— Full Image URL: ${FULL_IMAGE}"
          echo "ðŸ“Œ Commit SHA: ${COMMIT_SHA}"
          echo "ðŸ• Build Time: ${BUILD_TIME}"
          echo "ðŸŒ¿ Source Branch: ${SOURCE_BRANCH}"
          echo "ðŸ“‹ All Tags: ${ALL_TAGS}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Exportar como outputs
          echo "docker_image=${DOCKER_IMAGE}" >> $GITHUB_OUTPUT
          echo "gcp_project_id=${GCP_PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "gcp_region=${GCP_REGION}" >> $GITHUB_OUTPUT
          echo "artifact_registry=${ARTIFACT_REGISTRY}" >> $GITHUB_OUTPUT
          echo "tag_qa=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image_url=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "all_tags=${ALL_TAGS}" >> $GITHUB_OUTPUT
          echo "source_branch=${SOURCE_BRANCH}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Image information extracted and validated successfully"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Deployment QA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-qa:
    name: ðŸš€ Deploy to QA
    needs: [test, get-image-info]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-qa.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      gcp_project_id: ${{ needs.get-image-info.outputs.gcp_project_id }}
      gcp_region: ${{ needs.get-image-info.outputs.gcp_region }}
      artifact_registry: ${{ needs.get-image-info.outputs.artifact_registry }}
      environment: qa
      image_tag: ${{ needs.get-image-info.outputs.tag_qa }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Crear PR a Integration
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: deploy-qa
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'qa'
      target_branch: 'integration'
      pr_title: 'ðŸš€ Deploy qa to integration'
      environment: 'integration'
      labels: 'automated,deployment,integration,qa'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5 & 6: Aprobaciones manuales
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saludar:
    runs-on: 'ubuntu-latest'
    environment: 'qa'
    needs: create-pr-to-integration
    steps:
      - name: Hola Mundo
        run: echo "Â¡Hola Mundo!"

  saludar-2:
    runs-on: 'ubuntu-latest'
    environment: 'qa'
    needs: create-pr-to-integration
    steps:
      - name: Hola Mundo
        run: echo "Â¡Hola Mundo!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job FINAL: Resumen completo del workflow QA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow-summary:
    name: ðŸ“Š QA Workflow Summary
    needs: [test, get-image-info, deploy-qa, create-pr-to-integration, saludar, saludar-2]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate QA Workflow Summary
        run: |
          echo "# ðŸš€ QA Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Workflow Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status de cada job
          echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª QA Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Quality Assurance Tests |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Get Image Info | ${{ needs.get-image-info.result == 'success' && 'âœ… Retrieved' || 'âŒ Failed' }} | Downloaded from Artifact |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deploy to QA | ${{ needs.deploy-qa.result == 'success' && 'âœ… Deployed' || needs.deploy-qa.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Update K8s manifests |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Create PR | ${{ needs.create-pr-to-integration.result == 'success' && 'âœ… Created' || 'âŒ Failed' }} | QA â†’ Integration |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘‹ Manual Approval 1 | ${{ needs.saludar.result == 'success' && 'âœ… Approved' || needs.saludar.result == 'skipped' && 'â­ï¸ Skipped' || 'â¸ï¸ Pending' }} | Environment: qa |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘‹ Manual Approval 2 | ${{ needs.saludar-2.result == 'success' && 'âœ… Approved' || needs.saludar-2.result == 'skipped' && 'â­ï¸ Skipped' || 'â¸ï¸ Pending' }} | Environment: qa |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # InformaciÃ³n de la imagen desplegada
          if [[ "${{ needs.get-image-info.result }}" == "success" ]]; then
            echo "## ðŸ³ Deployed Image Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Name** | \`${{ needs.get-image-info.outputs.docker_image }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Tag** | \`${{ needs.get-image-info.outputs.tag_qa }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Full Image URL** | \`${{ needs.get-image-info.outputs.full_image_url }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Source Commit** | \`${{ needs.get-image-info.outputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Source Branch** | \`${{ needs.get-image-info.outputs.source_branch }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Environment** | \`qa\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“¦ Artifact Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Image metadata retrieved from GitHub Artifact" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Metadata del workflow
          echo "## ðŸ“‹ Workflow Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by QA Workflow - $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
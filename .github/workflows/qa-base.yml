permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: Run Qa Tests

on:
  push:
    branches:
      - qa      

jobs:
  test:
    name: Run Qa Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/qa.yml@main
    #with:
    #  sonar-token: ${{ secrets.SONAR_TOKEN }}
    #  branch: "qa"


# Job 2: Crear Pull Request desde QA hacia Integration
  create-pr:
      name: Create PR QA to Integration
      needs: test
      runs-on: ubuntu-latest
      if: success() && github.ref == 'refs/heads/qa'
      
      permissions:
        contents: read
        pull-requests: write
        issues: write
      
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
        
        - name: Create Pull Request via API
          uses: actions/github-script@v7
          with:
            github-token: ${{ secrets.GITHUB_TOKEN }}
            script: |
              const { owner, repo } = context.repo;
              
              try {
                // Verificar si ya existe un PR abierto de qa a integration
                console.log('ğŸ” Checking for existing PRs...');
                const { data: existingPRs } = await github.rest.pulls.list({
                  owner,
                  repo,
                  head: `${owner}:qa`,
                  base: 'integration',
                  state: 'open'
                });
                
                if (existingPRs.length > 0) {
                  const existingPR = existingPRs[0];
                  console.log(`âœ… PR already exists: #${existingPR.number}`);
                  console.log(`ğŸ“ URL: ${existingPR.html_url}`);
                  
                  // Actualizar el PR existente con un comentario
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: existingPR.number,
                    body: `ğŸ”„ **QA branch updated**
                    
                  Tests passed successfully âœ…

                  **Details:**
                  - Commit: \`${context.sha.substring(0, 7)}\`
                  - Workflow: [View run](https://github.com/${owner}/${repo}/actions/runs/${context.runId})
                  - Updated: ${new Date().toLocaleString('es-ES', { timeZone: 'Europe/Madrid' })}

                  ---
                  *Auto-updated by GitHub Actions*`
                                });
                                
                                // Opcional: AÃ±adir un label de "updated"
                                await github.rest.issues.addLabels({
                                  owner,
                                  repo,
                                  issue_number: existingPR.number,
                                  labels: ['qa-updated']
                                });
                                
                                return;
                              }
                              
                              // Obtener informaciÃ³n del Ãºltimo commit
                              const { data: commit } = await github.rest.repos.getCommit({
                                owner,
                                repo,
                                ref: 'qa'
                              });
                              
                              // Obtener diferencias entre qa e integration
                              const { data: comparison } = await github.rest.repos.compareCommits({
                                owner,
                                repo,
                                base: 'integration',
                                head: 'qa'
                              });
                              
                              console.log('ğŸ“ Creating new PR...');
                              
                              // Crear nuevo PR
                              const { data: pr } = await github.rest.pulls.create({
                                owner,
                                repo,
                                title: 'ğŸš€ Deploy QA to Integration',
                                head: 'qa',
                                base: 'integration',
                                body: `## ğŸ¯ Automatic Deployment: QA â†’ Integration
                                
                  This PR contains the latest tested changes from \`qa\` branch ready for the Integration environment.

                  ### ğŸ“Š Summary
                  - **Commits ahead:** ${comparison.ahead_by}
                  - **Files changed:** ${comparison.files.length}
                  - **Latest commit:** ${commit.commit.message.split('\n')[0]}

                  ### ğŸ“‹ Pre-merge Checklist
                  - [x] Tests passed âœ…
                  - [ ] Code reviewed
                  - [ ] Integration deployment approved
                  - [ ] Documentation updated (if needed)

                  ### ğŸ”— Links
                  - ğŸ”— [Workflow run](https://github.com/${owner}/${repo}/actions/runs/${context.runId})
                  - ğŸ“ [Latest commit](${commit.html_url})
                  - ğŸŒ¿ [Compare changes](https://github.com/${owner}/${repo}/compare/integration...qa)

                  ### ğŸ“… Details
                  - **Created:** ${new Date().toLocaleString('es-ES', { timeZone: 'Europe/Madrid' })}
                  - **Commit SHA:** \`${context.sha}\`

                  ---
                  *ğŸ¤– Auto-generated by GitHub Actions*`,
                                draft: false
                              });
                              
                              // AÃ±adir labels al PR
                              await github.rest.issues.addLabels({
                                owner,
                                repo,
                                issue_number: pr.number,
                                labels: ['automated', 'deployment', 'qaâ†’integration', 'needs-review']
                              });
                              
                              // Opcional: AÃ±adir reviewers
                              // Descomenta y personaliza segÃºn tu equipo
                              // await github.rest.pulls.requestReviewers({
                              //   owner,
                              //   repo,
                              //   pull_number: pr.number,
                              //   reviewers: ['reviewer1', 'reviewer2']
                              // });
                              
                              // Opcional: Asignar a alguien
                              // await github.rest.issues.addAssignees({
                              //   owner,
                              //   repo,
                              //   issue_number: pr.number,
                              //   assignees: ['team-lead']
                              // });
                              
                              console.log(`âœ… Pull Request created successfully!`);
                              console.log(`ğŸ“ PR #${pr.number}: ${pr.html_url}`);
                              
                              // Crear un resumen visible en el workflow
                              core.summary
                                .addHeading('Pull Request Created ğŸ‰')
                                .addLink(`PR #${pr.number}`, pr.html_url)
                                .addRaw(`\n\nFrom: \`qa\` â†’ To: \`integration\``)
                                .addRaw(`\n\nCommits: ${comparison.ahead_by}`)
                                .write();
                              
                            } catch (error) {
                              console.error('âŒ Error:', error.message);
                              core.setFailed(`Failed to create PR: ${error.message}`);
                              throw error;
                            }
                      
                      - name: Notify on failure
                        if: failure()
                        uses: actions/github-script@v7
                        with:
                          script: |
                            console.log('âš ï¸ Workflow failed. Check the logs for details.');
                            // AquÃ­ podrÃ­as enviar notificaciones a Slack, Teams, etc.
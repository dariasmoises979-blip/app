name: Run Unit Tests and Merge to Dev

on:
  push:
    branches: 
      - feature/**
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Llamar al workflow reusable de tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  test:
    name: Run Unit Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/test.yml@main

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Llamar al workflow reusable de merge
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  merge-to-dev:
    name: Merge to Dev
    needs: test  # âš™ï¸ Solo se ejecuta si los tests pasan
    # âœ… ValidaciÃ³n adicional: solo si es una rama feature
    if: startsWith(github.ref_name, 'feature/') && success()
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/auto-merge.yml@main   # ğŸ“‚ Ruta al workflow reusable
    with:
      source_branch: ${{ github.ref_name }}   # La rama feature actual
      target_branch: 'dev'                     # Fusionar hacia dev
      use_fast_forward: false                  # Crear commit de merge explÃ­cito
      merge_message: 'ğŸ”€ Auto-merge from ${{ github.ref_name }} after successful tests'


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Llamar al workflow reusable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: merge-to-dev  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main  # ğŸ“‚ Ruta al workflow reusable
    with:
      source_branch: 'dev'                    # Desde dev
      target_branch: 'qa'                     # Hacia qa
      pr_title: 'ğŸš€ Deploy DEV to QA'
      environment: 'qa'
      labels: 'automated,deployment,qa,dev'


      #test build
  build-image:
    name: Build Docker Image
    needs: create-pr-to-integration  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image.yml@main  # ğŸ“‚ Ruta al workflow reusable
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: qa
      dockerfile_path: ./Dockerfile
      build_context: .
      additional_tags: v1.0.0,stable
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
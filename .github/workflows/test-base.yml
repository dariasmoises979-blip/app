name: Run Unit Tests and Merge to Dev

on:
  push:
    branches: 
      - feature/**

jobs:
  test:
    name: Run Unit Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/test.yml@main

  # Job: Fusiona automÃ¡ticamente cualquier rama feature/* en la rama dev
  merge-to-dev:
    name: Merge Feature to Dev
    needs: test                     # Espera que el job "test" haya terminado
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'feature/') && success()
    # Solo se ejecuta si:
    # - El nombre de la rama actual comienza con "feature/"
    # - Las pruebas fueron exitosas

    permissions:
      contents: write               # Necesario para hacer push al repo
      pull-requests: write          # (Opcional) Permite crear/actualizar PRs si hiciera falta

    steps:
      # Paso 1: Clonar el repositorio completo
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                   # Obtiene todo el historial
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      # Paso 2: Configurar Git para los commits automÃ¡ticos
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Paso 3: Hacer merge desde la rama feature/** actual hacia dev
      - name: Merge feature into dev
        run: |
          git fetch origin dev                         # Trae la Ãºltima versiÃ³n de dev
          git checkout dev                             # Cambia a la rama dev
          git merge --no-ff origin/${{ github.ref_name }} -m "Auto-merge from ${{ github.ref_name }} after successful tests"
          # origin/${{ github.ref_name }} asegura que tomamos la versiÃ³n remota actual de la feature
          git push origin dev                          # EnvÃ­a los cambios fusionados a la rama dev
                                          # EnvÃ­a los cambios al repositorio remoto


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Llamar al workflow reusable
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: test  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main  # ğŸ“‚ Ruta al workflow reusable
    with:
      source_branch: 'dev'                    # Desde dev
      target_branch: 'qa'                     # Hacia qa
      pr_title: 'ğŸš€ Deploy DEV to QA'
      environment: 'qa'
      labels: 'automated,deployment,qa,dev'


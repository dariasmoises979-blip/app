name: Run Qa Tests

on:
  push:
    branches:
      - integration

permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: TESTS DE INTEGRACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ğŸ§ª Run Qa Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/integration.yml@main

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: BUILD DE IMÃGENES DOCKER - SEPARADO POR AMBIENTE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build - Ambiente PRE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-image-pre:
    name: ğŸ—ï¸ Build Docker Image - PRE
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-gcp.yml-gcp@main
    with:
      docker_image: mi-aplicacion
      environment: pre
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build - Ambiente STAGING
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-image-staging:
    name: ğŸ—ï¸ Build Docker Image - STAGING
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-gcp.yml@main
    with:
      docker_image: mi-aplicacion
      environment: staging
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build - Ambiente PRO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-image-pro:
    name: ğŸ—ï¸ Build Docker Image - PRO
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-gcp.yml@main
    with:
      docker_image: mi-aplicacion
      environment: pro
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: SECURITY SCAN - SEPARADO POR AMBIENTE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Security Scan - Ambiente PRE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-pre:
    name: ğŸ” Security Scan - PRE
    needs: build-image-pre
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/security.yml@main
    with:
      image_name: mi-aplicacion
      image_tag: pre
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      enable_sonar: true
      artifact_name: "security-reports-pre-${{ github.run_id }}"
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Security Scan - Ambiente STAGING
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-staging:
    name: ğŸ” Security Scan - STAGING
    needs: build-image-staging
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/security.yml@main
    with:
      image_name: mi-aplicacion
      image_tag: staging
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      enable_sonar: true
      artifact_name: "security-reports-staging-${{ github.run_id }}"
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Security Scan - Ambiente PRO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-pro:
    name: ğŸ” Security Scan - PRO
    needs: build-image-pro
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/security.yml@main
    with:
      image_name: mi-aplicacion
      image_tag: pro
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      enable_sonar: true
      artifact_name: "security-reports-pro-${{ github.run_id }}"
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: BUILD HÃBRIDO - SEPARADO POR AMBIENTE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build HÃ­brido - Ambiente PRE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  hybrid-pre:
    name: ğŸ”„ Build HÃ­brido - PRE
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      environment: pre
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build HÃ­brido - Ambiente STAGING
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  hybrid-staging:
    name: ğŸ”„ Build HÃ­brido - STAGING
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      environment: staging
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Build HÃ­brido - Ambiente PRO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  hybrid-pro:
    name: ğŸ”„ Build HÃ­brido - PRO
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      environment: pro
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: MAIN PIPELINE - SEPARADO POR AMBIENTE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Main Pipeline - Ambiente PRE
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  main-pipeline-pre:
    name: ğŸš€ Pipeline Completo - PRE
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/main-pipeline.yml@main
    with:
      docker_image: mi-aplicacion
      environment: pre
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
      
      # Opciones
      enable_security_scan: true
      enable_sonar: true
    
      # ConfiguraciÃ³n de SonarCloud
      sonar_project_base_dir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Main Pipeline - Ambiente STAGING
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  main-pipeline-staging:
    name: ğŸš€ Pipeline Completo - STAGING
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/main-pipeline.yml@main
    with:
      docker_image: mi-aplicacion
      environment: staging
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
      
      # Opciones
      enable_security_scan: true
      enable_sonar: true
    
      # ConfiguraciÃ³n de SonarCloud
      sonar_project_base_dir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Main Pipeline - Ambiente PRO
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  main-pipeline-pro:
    name: ğŸš€ Pipeline Completo - PRO
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/main-pipeline.yml@main
    with:
      docker_image: mi-aplicacion
      environment: pro
      
      # ConfiguraciÃ³n GCP Artifact Registry
      gcp_project_id: elite-ceremony-476307-s9
      gcp_region: us-central1
      artifact_registry: dariasmoises979
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
      
      # Opciones
      enable_security_scan: true
      enable_sonar: true
    
      # ConfiguraciÃ³n de SonarCloud
      sonar_project_base_dir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: GUARDAR TAGS GENERADOS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  save-image-info:
    name: ğŸ’¾ Save Image Tags
    runs-on: ubuntu-latest
    needs: [build-image-pre, build-image-staging, build-image-pro]
    steps:
      - name: Create image info file
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ SAVING IMAGE TAGS INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Crear archivo con informaciÃ³n de las imÃ¡genes para GCP Artifact Registry
          cat > image-info.env << EOF
          GCP_PROJECT_ID=elite-ceremony-476307-s9
          GCP_REGION=us-central1
          ARTIFACT_REGISTRY=dariasmoises979
          IMAGE_NAME=mi-aplicacion
          TAG_PRE=${{ needs.build-image-pre.outputs.image_tag }}
          TAG_STAGING=${{ needs.build-image-staging.outputs.image_tag }}
          TAG_PRO=${{ needs.build-image-pro.outputs.image_tag }}
          FULL_IMAGE_PRE=${{ needs.build-image-pre.outputs.full_image }}
          FULL_IMAGE_STAGING=${{ needs.build-image-staging.outputs.full_image }}
          FULL_IMAGE_PRO=${{ needs.build-image-pro.outputs.full_image }}
          SHORT_SHA=${{ needs.build-image-pre.outputs.short_sha }}
          BUILD_DATE="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"  
          COMMIT_SHA=${{ github.sha }}
          TRIGGERED_BY=${{ github.actor }}
          WORKFLOW_RUN=${{ github.run_id }}
          BRANCH=${{ github.ref_name }}
          EOF
          
          echo "âœ… Image info file created"
          echo ""
          echo "ğŸ“‹ Content:"
          cat image-info.env
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload image info artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-info
          path: image-info.env
          retention-days: 3
          overwrite: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 7: RESUMEN FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ğŸ“Š Resumen Final del Pipeline
    needs: 
      - security-pre
      - security-staging
      - security-pro
      - hybrid-pre
      - hybrid-staging
      - hybrid-pro
      - main-pipeline-pre
      - main-pipeline-staging
      - main-pipeline-pro
      - save-image-info
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“‹ Generar resumen consolidado
        run: |
          echo "## ğŸ“Š Resumen del Pipeline Completo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### â˜ï¸ GCP Artifact Registry" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: elite-ceremony-476307-s9" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: us-central1" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: dariasmoises979" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ—ï¸ Build de ImÃ¡genes" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PRE | ${{ needs.build-image-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | ${{ needs.build-image-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | ${{ needs.build-image-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ” AnÃ¡lisis de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PRE | ${{ needs.security-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | ${{ needs.security-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | ${{ needs.security-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”„ Build HÃ­brido" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PRE | ${{ needs.hybrid-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | ${{ needs.hybrid-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | ${{ needs.hybrid-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸš€ Pipeline Completo" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PRE | ${{ needs.main-pipeline-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | ${{ needs.main-pipeline-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | ${{ needs.main-pipeline-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ’¾ Artifact Guardado" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Save Tags | ${{ needs.save-image-info.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¯ **Tags guardados en artifact 'image-info' para uso en deployment**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”— **AcciÃ³n**: Los tags estÃ¡n disponibles para el workflow de deployment" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 8: CREATE PR TO MAIN
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-pr-to-integration:
    name: Create PR to Integration
    needs: summary
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'integration'
      target_branch: 'main'
      pr_title: 'ğŸš€ Deploy integration to main'
      environment: 'integration'
      labels: 'automated,deployment,main,integration'
name: Run Qa Tests

on:
  push:
    branches:
      - integration

permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

jobs:
  # ═══════════════════════════════════════════════════════════
  # JOB 1: TESTS DE INTEGRACIÓN
  # ═══════════════════════════════════════════════════════════
  test:
    name: 🧪 Run Qa Tests
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/integration.yml@main

  # ═══════════════════════════════════════════════════════════
  # JOB 2: BUILD DE IMÁGENES DOCKER - SEPARADO POR AMBIENTE
  # ═══════════════════════════════════════════════════════════
  
  # ──────────────────────────────────────────────────────────
  # Build - Ambiente PRE
  # ──────────────────────────────────────────────────────────
  build-image-pre:
    name: 🏗️ Build Docker Image - PRE
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: pre
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # ──────────────────────────────────────────────────────────
  # Build - Ambiente STAGING
  # ──────────────────────────────────────────────────────────
  build-image-staging:
    name: 🏗️ Build Docker Image - STAGING
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: staging
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # ──────────────────────────────────────────────────────────
  # Build - Ambiente PRO
  # ──────────────────────────────────────────────────────────
  build-image-pro:
    name: 🏗️ Build Docker Image - PRO
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: pro
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app  
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # ═══════════════════════════════════════════════════════════
  # JOB 3: GUARDAR INFORMACIÓN DE TAGS (CRÍTICO PARA DEPLOYMENT)
  # ═══════════════════════════════════════════════════════════
  save-image-tags:
    name: 💾 Save Image Tags Info
    runs-on: ubuntu-latest
    needs: [build-image-pre, build-image-staging, build-image-pro]
    steps:
      - name: Create Tags Info File
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "💾 SAVING BUILD TAGS INFORMATION"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Crear archivo con información de los tags
          cat > image-tags.json << EOF
          {
            "dockerhub_username": "dariasmoises979",
            "docker_image": "mi-aplicacion",
            "build_timestamp": "$(date -u +'%Y-%m-%d %H:%M:%S UTC')",
            "workflow_run_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "environments": {
              "pre": {
                "tag": "${{ needs.build-image-pre.outputs.image_tag }}",
                "full_image": "${{ needs.build-image-pre.outputs.full_image }}",
                "short_sha": "${{ needs.build-image-pre.outputs.short_sha }}"
              },
              "staging": {
                "tag": "${{ needs.build-image-staging.outputs.image_tag }}",
                "full_image": "${{ needs.build-image-staging.outputs.full_image }}",
                "short_sha": "${{ needs.build-image-staging.outputs.short_sha }}"
              },
              "pro": {
                "tag": "${{ needs.build-image-pro.outputs.image_tag }}",
                "full_image": "${{ needs.build-image-pro.outputs.full_image }}",
                "short_sha": "${{ needs.build-image-pro.outputs.short_sha }}"
              }
            }
          }
          EOF
          
          # También crear archivo .env para fácil lectura
          cat > image-tags.env << EOF
          DOCKERHUB_USERNAME=dariasmoises979
          DOCKER_IMAGE=mi-aplicacion
          BUILD_TIMESTAMP=$(date -u +'%Y-%m-%d_%H-%M-%S')
          WORKFLOW_RUN_ID=${{ github.run_id }}
          COMMIT_SHA=${{ github.sha }}
          BRANCH=${{ github.ref_name }}
          
          # Tags por ambiente
          TAG_PRE=${{ needs.build-image-pre.outputs.image_tag }}
          FULL_IMAGE_PRE=${{ needs.build-image-pre.outputs.full_image }}
          
          TAG_STAGING=${{ needs.build-image-staging.outputs.image_tag }}
          FULL_IMAGE_STAGING=${{ needs.build-image-staging.outputs.full_image }}
          
          TAG_PRO=${{ needs.build-image-pro.outputs.image_tag }}
          FULL_IMAGE_PRO=${{ needs.build-image-pro.outputs.full_image }}
          EOF
          
          echo "✅ Files created:"
          echo "   • image-tags.json"
          echo "   • image-tags.env"
          echo ""
          echo "📋 Content preview (JSON):"
          cat image-tags.json
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Upload Tags as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-image-tags
          path: |
            image-tags.json
            image-tags.env
          retention-days: 30

      - name: Checkout Pipeline Repo
        uses: actions/checkout@v4
        with:
          repository: dariasmoises979-blip/pipeline-build
          token: ${{ secrets.GH_TOKEN2 }}
          path: pipeline-build

      - name: Save Tags to Repository
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "💾 SAVING TAGS TO REPOSITORY"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # Crear directorio de cache si no existe
          mkdir -p pipeline-build/.github/cache
          
          # Copiar archivos de tags
          cp image-tags.json pipeline-build/.github/cache/latest-tags.json
          cp image-tags.env pipeline-build/.github/cache/latest-tags.env
          
          # Configurar Git
          cd pipeline-build
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit y push
          git add .github/cache/
          git commit -m "🏷️ Update image tags from build ${{ github.run_id }}

          Build Information:
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          
          Tags Generated:
          - PRE: ${{ needs.build-image-pre.outputs.image_tag }}
          - STAGING: ${{ needs.build-image-staging.outputs.image_tag }}
          - PRO: ${{ needs.build-image-pro.outputs.image_tag }}" || echo "No changes to commit"
          
          git push
          
          echo "✅ Tags saved to repository:"
          echo "   • .github/cache/latest-tags.json"
          echo "   • .github/cache/latest-tags.env"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

  # ═══════════════════════════════════════════════════════════
  # JOB 4: SECURITY SCAN - SEPARADO POR AMBIENTE
  # ═══════════════════════════════════════════════════════════
  
  security-pre:
    name: 🔐 Security Scan - PRE
    needs: build-image-pre
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/security.yml@main
    with:
      image_name: "dariasmoises979/mi-aplicacion"
      image_tag: "pre"
      dockerhub_username: "dariasmoises979"
      enable_sonar: true
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ──────────────────────────────────────────────────────────
  # Security Scan - Ambiente STAGING
  # ──────────────────────────────────────────────────────────
  security-staging:
    name: 🔐 Security Scan - STAGING
    needs: build-image-staging
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/security.yml@main
    with:
      image_name: "dariasmoises979/mi-aplicacion"
      image_tag: "staging"
      dockerhub_username: "dariasmoises979"
      enable_sonar: true
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  # ──────────────────────────────────────────────────────────
  # Security Scan - Ambiente PRO
  # ──────────────────────────────────────────────────────────
  security-pro:
    name: 🔐 Security Scan - PRO
    needs: build-image-pro
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/security.yml@main
    with:
      image_name: "dariasmoises979/mi-aplicacion"
      image_tag: "pro"
      dockerhub_username: "dariasmoises979"
      enable_sonar: true
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ═══════════════════════════════════════════════════════════
  # JOB 5: BUILD HÍBRIDO - SEPARADO POR AMBIENTE
  # ═══════════════════════════════════════════════════════════
  # ──────────────────────────────────────────────────────────
  # Build Híbrido - Ambiente PRE
  # ──────────────────────────────────────────────────────────
  hybrid-pre:
    name: 🔄 Build Híbrido - PRE
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: pre
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # ──────────────────────────────────────────────────────────
  # Build Híbrido - Ambiente STAGING
  # ──────────────────────────────────────────────────────────
  hybrid-staging:
    name: 🔄 Build Híbrido - STAGING
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: staging
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # ──────────────────────────────────────────────────────────
  # Build Híbrido - Ambiente PRO
  # ──────────────────────────────────────────────────────────
  hybrid-pro:
    name: 🔄 Build Híbrido - PRO
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-hybrid.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: pro
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: local/Dockerfile
      build_context: ./app-repo
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}

  # ═══════════════════════════════════════════════════════════
  # JOB 6: MAIN PIPELINE - SEPARADO POR AMBIENTE
  # ═══════════════════════════════════════════════════════════
  
  # ──────────────────────────────────────────────────────────
  # Main Pipeline - Ambiente PRE
  # ──────────────────────────────────────────────────────────
  main-pipeline-pre:
    name: 🚀 Pipeline Completo - PRE
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/main-pipeline.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: pre
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
      
      # Opciones
      enable_security_scan: true
      enable_sonar: true
    
      # Configuración de SonarCloud
      sonar_project_base_dir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ──────────────────────────────────────────────────────────
  # Main Pipeline - Ambiente STAGING
  # ──────────────────────────────────────────────────────────
  main-pipeline-staging:
    name: 🚀 Pipeline Completo - STAGING
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/main-pipeline.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: staging
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
      
      # Opciones
      enable_security_scan: true
      enable_sonar: true
    
      # Configuración de SonarCloud
      sonar_project_base_dir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ──────────────────────────────────────────────────────────
  # Main Pipeline - Ambiente PRO
  # ──────────────────────────────────────────────────────────
  main-pipeline-pro:
    name: 🚀 Pipeline Completo - PRO
    needs: test
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/main-pipeline.yml@main
    with:
      docker_image: mi-aplicacion
      dockerhub_username: dariasmoises979
      environment: pro
      
      # Configuración del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo
      
      # Opciones
      enable_security_scan: true
      enable_sonar: true
    
      # Configuración de SonarCloud
      sonar_project_base_dir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ═══════════════════════════════════════════════════════════
  # JOB 7: RESUMEN FINAL
  # ═══════════════════════════════════════════════════════════
  summary:
    name: 📊 Resumen Final del Pipeline
    needs: 
      - security-pre
      - security-staging
      - security-pro
      - hybrid-pre
      - hybrid-staging
      - hybrid-pro
      - main-pipeline-pre
      - main-pipeline-staging
      - main-pipeline-pro
      - save-image-tags
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: 📋 Generar resumen consolidado
        run: |
          echo "## 📊 Resumen del Pipeline Completo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 🏗️ Build de Imágenes" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PRE | ${{ needs.build-image-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | ${{ needs.build-image-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | ${{ needs.build-image-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 🔐 Análisis de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "| Ambiente | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PRE | ${{ needs.security-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| STAGING | ${{ needs.security-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PRO | ${{ needs.security-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 💾 Guardado de Tags" >> $GITHUB_STEP_SUMMARY
          echo "| Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ needs.save-image-tags.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "🎯 **Los tags han sido guardados y están listos para deployment automático**" >> $GITHUB_STEP_SUMMARY

  # ═══════════════════════════════════════════════════════════
  # JOB 8: CREAR PR A MAIN (TRIGGER PARA DEPLOYMENT)
  # ═══════════════════════════════════════════════════════════
  create-pr-to-main:
    name: 📤 Create PR to Main
    needs: [summary, save-image-tags]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'integration'
      target_branch: 'main'
      pr_title: '🚀 Deploy integration to main'
      environment: 'integration'
      labels: 'automated,deployment,main,integration'
########################################
# ğŸš€ DEPLOYMENT WORKFLOW
# Consume los tags del workflow de integration y despliega
# ğŸ†• LEE LOS TAGS DESDE EL ARTIFACT GENERADO
#04-base_deployment_main.yml
########################################

name: Deploy to Environments

on:
  workflow_run:
    workflows: ["Run Qa Tests"]  # Nombre del workflow 03-integration_base.yml
    types:
      - completed

  # Permitir ejecuciÃ³n manual para re-deploys
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - pre
          - staging
          - pro
      workflow_run_id:
        description: 'Workflow Run ID to get artifacts from (leave empty for latest)'
        required: false
        type: string

permissions:
  actions: read
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 1: VERIFICAR Y DESCARGAR ARTIFACT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  get-image-info:
    name: ğŸ“¥ Get Image Tags from Artifact
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    outputs:
      tag_pre: ${{ steps.read-info.outputs.tag_pre }}
      tag_staging: ${{ steps.read-info.outputs.tag_staging }}
      tag_pro: ${{ steps.read-info.outputs.tag_pro }}
      image_name: ${{ steps.read-info.outputs.image_name }}
      full_image_pre: ${{ steps.read-info.outputs.full_image_pre }}
      full_image_staging: ${{ steps.read-info.outputs.full_image_staging }}
      full_image_pro: ${{ steps.read-info.outputs.full_image_pro }}
      dockerhub_username: ${{ steps.read-info.outputs.dockerhub_username }}
      docker_image: ${{ steps.read-info.outputs.docker_image }}
    
    steps:
      - name: Display Trigger Information
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ DEPLOYMENT TRIGGER INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”— Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "ğŸ“‹ Triggered by workflow: ${{ github.event.workflow_run.name }}"
            echo "âœ… Status: ${{ github.event.workflow_run.conclusion }}"
            echo "ğŸ”¢ Run ID: ${{ github.event.workflow_run.id }}"
            echo "ğŸŒ¿ Branch: ${{ github.event.workflow_run.head_branch }}"
          else
            echo "ğŸ–±ï¸  Manual trigger"
            echo "ğŸŒ Selected environment: ${{ github.event.inputs.environment }}"
            if [ -n "${{ github.event.inputs.workflow_run_id }}" ]; then
              echo "ğŸ”¢ Using Run ID: ${{ github.event.inputs.workflow_run_id }}"
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Download artifact from integration workflow
        uses: actions/download-artifact@v4
        with:
          name: image-info
          run-id: ${{ github.event.inputs.workflow_run_id || github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify artifact downloaded
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ ARTIFACT VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Current directory:"
          pwd
          echo ""
          echo "ğŸ“‹ Files downloaded:"
          ls -la
          echo ""
          if [ -f "image-info.env" ]; then
            echo "âœ… image-info.env found"
            echo ""
            echo "ğŸ“„ Content:"
            cat image-info.env
          else
            echo "âŒ ERROR: image-info.env not found!"
            echo ""
            echo "Available files:"
            ls -la
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Read image info and export
        id: read-info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“– READING IMAGE INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Cargar variables del archivo
          source image-info.env
          
          # Exportar como outputs del job
          echo "tag_pre=${TAG_PRE}" >> $GITHUB_OUTPUT
          echo "tag_staging=${TAG_STAGING}" >> $GITHUB_OUTPUT
          echo "tag_pro=${TAG_PRO}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "full_image_pre=${FULL_IMAGE_PRE}" >> $GITHUB_OUTPUT
          echo "full_image_staging=${FULL_IMAGE_STAGING}" >> $GITHUB_OUTPUT
          echo "full_image_pro=${FULL_IMAGE_PRO}" >> $GITHUB_OUTPUT
          
          # Extraer username y nombre de imagen
          DOCKERHUB_USERNAME=$(echo ${IMAGE_NAME} | cut -d'/' -f1)
          DOCKER_IMAGE=$(echo ${IMAGE_NAME} | cut -d'/' -f2)
          
          echo "dockerhub_username=${DOCKERHUB_USERNAME}" >> $GITHUB_OUTPUT
          echo "docker_image=${DOCKER_IMAGE}" >> $GITHUB_OUTPUT
          
          echo "âœ… Variables exported successfully"
          echo ""
          echo "ğŸ“‹ Exported values:"
          echo "   â€¢ Image Name: ${IMAGE_NAME}"
          echo "   â€¢ Docker Hub User: ${DOCKERHUB_USERNAME}"
          echo "   â€¢ Docker Image: ${DOCKER_IMAGE}"
          echo "   â€¢ Tag PRE: ${TAG_PRE}"
          echo "   â€¢ Tag STAGING: ${TAG_STAGING}"
          echo "   â€¢ Tag PRO: ${TAG_PRO}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 2: DEPLOY A PRE (AutomÃ¡tico)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pre:
    name: ğŸš€ Deploy to PRE
    needs: get-image-info
    if: |
      github.event_name == 'workflow_run' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'pre')
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: pre
      image_tag: ${{ needs.get-image-info.outputs.tag_pre }}
      dockerhub_username: ${{ needs.get-image-info.outputs.dockerhub_username }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps][PRE]"
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ JOB 3: DEPLOY A STAGING (AutomÃ¡tico)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: ğŸš€ Deploy to STAGING
    needs: [get-image-info, deploy-pre]
    if: |
      github.event_name == 'workflow_run' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: staging
      image_tag: ${{ needs.get-image-info.outputs.tag_staging }}
      dockerhub_username: ${{ needs.get-image-info.outputs.dockerhub_username }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps][STAGING]"
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 4: DEPLOY A PRO (Manual - Requiere AprobaciÃ³n)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pro:
    name: ğŸ” Deploy to PRO (Requires Approval)
    needs: [get-image-info, deploy-staging]
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.environment == 'pro'
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: pro
      image_tag: ${{ needs.get-image-info.outputs.tag_pro }}
      dockerhub_username: ${{ needs.get-image-info.outputs.dockerhub_username }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps][PRO]"
      requires_approval: true
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 5: RESUMEN FINAL DEL DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs:
      - get-image-info
      - deploy-pre
      - deploy-staging
      - deploy-pro
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ³ Docker Images Deployed:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image: ${{ needs.get-image-info.outputs.image_name }}"
          echo ""
          echo "ğŸŒ PRE Environment:"
          echo "   â€¢ Tag: ${{ needs.get-image-info.outputs.tag_pre }}"
          echo "   â€¢ Full Image: ${{ needs.get-image-info.outputs.full_image_pre }}"
          echo "   â€¢ Status: ${{ needs.deploy-pre.result }}"
          echo ""
          echo "ğŸŒ STAGING Environment:"
          echo "   â€¢ Tag: ${{ needs.get-image-info.outputs.tag_staging }}"
          echo "   â€¢ Full Image: ${{ needs.get-image-info.outputs.full_image_staging }}"
          echo "   â€¢ Status: ${{ needs.deploy-staging.result }}"
          echo ""
          echo "ğŸŒ PRO Environment:"
          echo "   â€¢ Tag: ${{ needs.get-image-info.outputs.tag_pro }}"
          echo "   â€¢ Full Image: ${{ needs.get-image-info.outputs.full_image_pro }}"
          echo "   â€¢ Status: ${{ needs.deploy-pro.result || 'not triggered' }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Job Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   â€¢ Get Image Info: ${{ needs.get-image-info.result }}"
          echo "   â€¢ Deploy PRE: ${{ needs.deploy-pre.result }}"
          echo "   â€¢ Deploy STAGING: ${{ needs.deploy-staging.result }}"
          echo "   â€¢ Deploy PRO: ${{ needs.deploy-pro.result || 'skipped' }}"
          echo ""
          echo "ğŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo ""
          echo "ğŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check for Failures
        if: |
          needs.get-image-info.result == 'failure' ||
          needs.deploy-pre.result == 'failure' ||
          needs.deploy-staging.result == 'failure' ||
          needs.deploy-pro.result == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  One or more deployment jobs failed"
          echo ""
          echo "ğŸ” Failed Jobs:"
          [ "${{ needs.get-image-info.result }}" == "failure" ] && echo "   â€¢ Get Image Info"
          [ "${{ needs.deploy-pre.result }}" == "failure" ] && echo "   â€¢ Deploy PRE"
          [ "${{ needs.deploy-staging.result }}" == "failure" ] && echo "   â€¢ Deploy STAGING"
          [ "${{ needs.deploy-pro.result }}" == "failure" ] && echo "   â€¢ Deploy PRO"
          echo ""
          echo "ğŸ”— Check logs at:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

      - name: Success Summary
        if: |
          needs.get-image-info.result == 'success' &&
          needs.deploy-pre.result == 'success' &&
          needs.deploy-staging.result == 'success'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ¯ Next Steps:"
          echo "   1. âœ… Manifests updated in repository"
          echo "   2. ğŸ”„ ArgoCD will detect and sync changes"
          echo "   3. ğŸš€ Applications will be deployed automatically"
          echo "   4. ğŸ“Š Monitor ArgoCD for sync status"
          echo ""
          echo "ğŸ”— Resources:"
          echo "   â€¢ Repository: ${{ github.server_url }}/${{ github.repository }}"
          echo "   â€¢ Manifests: kubernetes/pre, kubernetes/staging, kubernetes/pro"
          echo "   â€¢ Docker Hub: https://hub.docker.com/r/${{ needs.get-image-info.outputs.dockerhub_username }}/${{ needs.get-image-info.outputs.docker_image }}"
          echo ""
          if [ "${{ needs.deploy-pro.result }}" == "skipped" ]; then
            echo "â„¹ï¸  PRO deployment skipped (requires manual trigger)"
            echo "   To deploy to PRO, run this workflow manually and select 'pro' environment"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
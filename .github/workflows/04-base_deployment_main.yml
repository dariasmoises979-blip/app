permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: ğŸš€ GitOps Deployment (Base Trigger)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # âœ… Permite ejecuciÃ³n manual

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job 1: Ejecutar Deployment GitOps
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  gitops-deploy:
    name: ğŸš€ Run Reusable GitOps Deployment
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-main.yml@main
    with:
      environment: "dev"                      # ğŸŸ¢ Cambia segÃºn el entorno (dev, staging, pre, prod)
      image_tag: "latest"                     # ğŸ·ï¸  Tag de la imagen Docker a desplegar
      dockerhub_username: "dariasmoises979"        # ğŸ‘¤ Usuario de Docker Hub
      docker_image: "mi-imagen"               # ğŸ“¦ Nombre de la imagen Docker
      manifests_path: "k8s"                   # ğŸ“‚ Ruta a los manifiestos
      manifest_file_pattern: "*.yaml"         # ğŸ“„ PatrÃ³n de archivos
      git_user_name: "github-actions[bot]"    # ğŸ‘¤ Usuario Git
      git_user_email: "github-actions[bot]@users.noreply.github.com"
      commit_message_prefix: "[GitOps]"       # ğŸ“ Prefijo del commit
      requires_approval: false                # ğŸ” Si requiere aprobaciÃ³n manual (pre/prod)
    secrets: inherit

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job 2: Crear Pull Request a integraciÃ³n (opcional)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: ğŸ”€ Create PR to Integration
    needs: gitops-deploy
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: "main"
      target_branch: "integration"
      pr_title: "ğŸš€ Deploy main to integration"
      environment: "integration"
      labels: "automated,deployment,gitops"
    secrets: inherit

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job 3: Mensaje final (opcional / manual)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    runs-on: ubuntu-latest
    needs: create-pr-to-integration
    steps:
      - name: âœ… Deployment Done
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ GitOps Deployment completed successfully!"
          echo "ğŸŒ Environment: dev"
          echo "ğŸ·ï¸  Image: mi-usuario/mi-imagen:latest"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

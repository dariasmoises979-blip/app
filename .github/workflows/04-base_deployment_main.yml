########################################
# ðŸš€ DEPLOYMENT WORKFLOW - AUTOMÃTICO
# Se dispara automÃ¡ticamente cuando completa el workflow de integration
# Lee los tags del artifact y despliega sin intervenciÃ³n manual
# 04-base_deployment_main.yml
########################################

name: Deploy Updated Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main


permissions:
  actions: read
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 1: OBTENER TAGS DEL ARTIFACT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  get-image-tags:
    name: ðŸ“¥ Get Image Tags from Build
    runs-on: ubuntu-latest
    outputs:
      tag_pre: ${{ steps.read-info.outputs.tag_pre }}
      tag_staging: ${{ steps.read-info.outputs.tag_staging }}
      tag_pro: ${{ steps.read-info.outputs.tag_pro }}
      dockerhub_username: ${{ steps.read-info.outputs.dockerhub_username }}
      docker_image: ${{ steps.read-info.outputs.docker_image }}
      image_name: ${{ steps.read-info.outputs.image_name }}
    
    steps:
      - name: Display Workflow Trigger Info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¯ DEPLOYMENT WORKFLOW TRIGGERED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ Triggered by workflow: "Push/PR to main""
          echo "âœ… Workflow status: ${{ github.event_name }}"
          echo "ðŸ”¢ Workflow Run ID: ${{ github.run_id }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ðŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Download artifact from integration workflow
        uses: actions/download-artifact@v4
        with:
          name: image-info.env
          repository: dariasmoises979-blip/app
          run-id: ${{ github.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify artifact downloaded
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ARTIFACT VERIFICATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ Current directory: $(pwd)"
          echo ""
          echo "ðŸ“‹ Downloaded files:"
          ls -la
          echo ""
          
          if [ -f "image-info.env" ]; then
            echo "âœ… image-info.env found successfully"
            echo ""
            echo "ðŸ“„ File content:"
            cat image-info.env
          else
            echo "âŒ ERROR: image-info.env not found!"
            echo ""
            echo "Available files in directory:"
            ls -la
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Read and export image information
        id: read-info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“– READING IMAGE TAGS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Cargar todas las variables del archivo
          source image-info.env
          
          # Exportar como outputs del job para otros jobs
          echo "tag_pre=${TAG_PRE}" >> $GITHUB_OUTPUT
          echo "tag_staging=${TAG_STAGING}" >> $GITHUB_OUTPUT
          echo "tag_pro=${TAG_PRO}" >> $GITHUB_OUTPUT
          echo "dockerhub_username=${DOCKERHUB_USERNAME}" >> $GITHUB_OUTPUT
          echo "docker_image=${DOCKER_IMAGE}" >> $GITHUB_OUTPUT
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          
          echo "âœ… Tags extracted successfully"
          echo ""
          echo "ðŸ“‹ Image Information:"
          echo "   â€¢ Docker Hub User: ${DOCKERHUB_USERNAME}"
          echo "   â€¢ Docker Image: ${DOCKER_IMAGE}"
          echo "   â€¢ Full Image Name: ${IMAGE_NAME}"
          echo ""
          echo "ðŸ·ï¸  Tags by Environment:"
          echo "   â€¢ PRE:     ${TAG_PRE}"
          echo "   â€¢ STAGING: ${TAG_STAGING}"
          echo "   â€¢ PRO:     ${TAG_PRO}"
          echo ""
          echo "ðŸ“¦ Full Images:"
          echo "   â€¢ PRE:     ${FULL_IMAGE_PRE}"
          echo "   â€¢ STAGING: ${FULL_IMAGE_STAGING}"
          echo "   â€¢ PRO:     ${FULL_IMAGE_PRO}"
          echo ""
          echo "ðŸ“Š Build Info:"
          echo "   â€¢ Short SHA: ${SHORT_SHA}"
          echo "   â€¢ Build Date: ${BUILD_DATE}"
          echo "   â€¢ Commit: ${COMMIT_SHA}"
          echo "   â€¢ Branch: ${BRANCH}"
          echo "   â€¢ Triggered by: ${TRIGGERED_BY}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ JOB 2: DEPLOY A PRE (AUTOMÃTICO)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pre:
    name: ðŸš€ Deploy to PRE
    needs: get-image-tags
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: pre
      image_tag: ${{ needs.get-image-tags.outputs.tag_pre }}
      dockerhub_username: ${{ needs.get-image-tags.outputs.dockerhub_username }}
      docker_image: ${{ needs.get-image-tags.outputs.docker_image }}
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps][PRE]"
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ JOB 3: DEPLOY A STAGING (AUTOMÃTICO - DESPUÃ‰S DE PRE)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: ðŸš€ Deploy to STAGING
    needs: [get-image-tags, deploy-pre]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: staging
      image_tag: ${{ needs.get-image-tags.outputs.tag_staging }}
      dockerhub_username: ${{ needs.get-image-tags.outputs.dockerhub_username }}
      docker_image: ${{ needs.get-image-tags.outputs.docker_image }}
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps][STAGING]"
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 4: DEPLOY A PRO (AUTOMÃTICO - DESPUÃ‰S DE STAGING)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pro:
    name: ðŸ” Deploy to PRO
    needs: [get-image-tags, deploy-staging]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: pro
      image_tag: ${{ needs.get-image-tags.outputs.tag_pro }}
      dockerhub_username: ${{ needs.get-image-tags.outputs.dockerhub_username }}
      docker_image: ${{ needs.get-image-tags.outputs.docker_image }}
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps][PRO]"
      requires_approval: true  # Requiere aprobaciÃ³n en GitHub Environments
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“Š JOB 5: RESUMEN FINAL DEL DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    needs:
      - get-image-tags
      - deploy-pre
      - deploy-staging
      - deploy-pro
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ³ Docker Images Deployed:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ Base Image: ${{ needs.get-image-tags.outputs.image_name }}"
          echo ""
          echo "ðŸŒ PRE Environment:"
          echo "   â€¢ Tag: ${{ needs.get-image-tags.outputs.tag_pre }}"
          echo "   â€¢ Status: ${{ needs.deploy-pre.result }}"
          echo "   â€¢ Location: kubernetes/pre/"
          echo ""
          echo "ðŸŒ STAGING Environment:"
          echo "   â€¢ Tag: ${{ needs.get-image-tags.outputs.tag_staging }}"
          echo "   â€¢ Status: ${{ needs.deploy-staging.result }}"
          echo "   â€¢ Location: kubernetes/staging/"
          echo ""
          echo "ðŸŒ PRO Environment:"
          echo "   â€¢ Tag: ${{ needs.get-image-tags.outputs.tag_pro }}"
          echo "   â€¢ Status: ${{ needs.deploy-pro.result }}"
          echo "   â€¢ Location: kubernetes/pro/"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ Job Results Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   â€¢ Get Tags:       ${{ needs.get-image-tags.result }}"
          echo "   â€¢ Deploy PRE:     ${{ needs.deploy-pre.result }}"
          echo "   â€¢ Deploy STAGING: ${{ needs.deploy-staging.result }}"
          echo "   â€¢ Deploy PRO:     ${{ needs.deploy-pro.result }}"
          echo ""
          echo "ðŸ• Completed: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo ""
          echo "ðŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ðŸ”— Source Build:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check for Failures
        if: |
          needs.get-image-tags.result == 'failure' ||
          needs.deploy-pre.result == 'failure' ||
          needs.deploy-staging.result == 'failure' ||
          needs.deploy-pro.result == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  One or more deployment jobs failed"
          echo ""
          echo "ðŸ” Failed Jobs:"
          [ "${{ needs.get-image-tags.result }}" == "failure" ] && echo "   â€¢ Get Image Tags"
          [ "${{ needs.deploy-pre.result }}" == "failure" ] && echo "   â€¢ Deploy PRE"
          [ "${{ needs.deploy-staging.result }}" == "failure" ] && echo "   â€¢ Deploy STAGING"
          [ "${{ needs.deploy-pro.result }}" == "failure" ] && echo "   â€¢ Deploy PRO"
          echo ""
          echo "ðŸ”— Check detailed logs at:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

      - name: Success Notification
        if: |
          needs.get-image-tags.result == 'success' &&
          needs.deploy-pre.result == 'success' &&
          needs.deploy-staging.result == 'success' &&
          needs.deploy-pro.result == 'success'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL DEPLOYMENTS COMPLETED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸŽ¯ What happened:"
          echo "   1. âœ… Tags retrieved from integration build"
          echo "   2. âœ… PRE manifests updated and committed"
          echo "   3. âœ… STAGING manifests updated and committed"
          echo "   4. âœ… PRO manifests updated and committed"
          echo ""
          echo "ðŸ”„ Next Steps:"
          echo "   â€¢ ArgoCD will detect the changes"
          echo "   â€¢ Applications will sync automatically"
          echo "   â€¢ Monitor ArgoCD UI for deployment status"
          echo ""
          echo "ðŸ“‚ Updated Locations:"
          echo "   â€¢ kubernetes/pre/*.yaml"
          echo "   â€¢ kubernetes/staging/*.yaml"
          echo "   â€¢ kubernetes/pro/*.yaml"
          echo ""
          echo "ðŸ”— View Changes:"
          echo "   git log kubernetes/ -3"
          echo ""
          echo "ðŸ³ Docker Images:"
          echo "   â€¢ PRE:     ${{ needs.get-image-tags.outputs.dockerhub_username }}/${{ needs.get-image-tags.outputs.docker_image }}:${{ needs.get-image-tags.outputs.tag_pre }}"
          echo "   â€¢ STAGING: ${{ needs.get-image-tags.outputs.dockerhub_username }}/${{ needs.get-image-tags.outputs.docker_image }}:${{ needs.get-image-tags.outputs.tag_staging }}"
          echo "   â€¢ PRO:     ${{ needs.get-image-tags.outputs.dockerhub_username }}/${{ needs.get-image-tags.outputs.docker_image }}:${{ needs.get-image-tags.outputs.tag_pro }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create Job Summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Images Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Tag | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **PRE** | \`${{ needs.get-image-tags.outputs.tag_pre }}\` | ${{ needs.deploy-pre.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **STAGING** | \`${{ needs.get-image-tags.outputs.tag_staging }}\` | ${{ needs.deploy-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **PRO** | \`${{ needs.get-image-tags.outputs.tag_pro }}\` | ${{ needs.deploy-pro.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Updated Locations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`kubernetes/pre/\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`kubernetes/staging/\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`kubernetes/pro/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Source Build](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/${{ needs.get-image-tags.outputs.dockerhub_username }}/${{ needs.get-image-tags.outputs.docker_image }}/tags)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
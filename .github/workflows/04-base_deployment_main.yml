permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

name: 🚀 GitOps Deployment (Base Trigger)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ✅ Permite ejecución manual

# ───────────────────────────────────────────────────────────
# Job 1: Ejecutar Deployment GitOps
# ───────────────────────────────────────────────────────────
jobs:
  gitops-deploy:
    name: 🚀 Run Reusable GitOps Deployment
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-main.yml@main
    with:
      environment: "dev"                      # 🟢 Cambia según el entorno (dev, staging, pre, prod)
      image_tag: "latest"                     # 🏷️  Tag de la imagen Docker a desplegar
      dockerhub_username: "dariasmoises979"        # 👤 Usuario de Docker Hub
      docker_image: "mi-imagen"               # 📦 Nombre de la imagen Docker
      manifests_path: "k8s"                   # 📂 Ruta a los manifiestos
      manifest_file_pattern: "*.yaml"         # 📄 Patrón de archivos
      git_user_name: "github-actions[bot]"    # 👤 Usuario Git
      git_user_email: "github-actions[bot]@users.noreply.github.com"
      commit_message_prefix: "[GitOps]"       # 📝 Prefijo del commit
      requires_approval: false                # 🔐 Si requiere aprobación manual (pre/prod)
    secrets: inherit

# ───────────────────────────────────────────────────────────
# Job 2: Crear Pull Request a integración (opcional)
# ───────────────────────────────────────────────────────────
  create-pr-to-integration:
    name: 🔀 Create PR to Integration
    needs: gitops-deploy
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: "main"
      target_branch: "integration"
      pr_title: "🚀 Deploy main to integration"
      environment: "integration"
      labels: "automated,deployment,gitops"
    secrets: inherit

# ───────────────────────────────────────────────────────────
# Job 3: Mensaje final (opcional / manual)
# ───────────────────────────────────────────────────────────
  notify:
    runs-on: ubuntu-latest
    needs: create-pr-to-integration
    steps:
      - name: ✅ Deployment Done
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🎉 GitOps Deployment completed successfully!"
          echo "🌍 Environment: dev"
          echo "🏷️  Image: mi-usuario/mi-imagen:latest"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

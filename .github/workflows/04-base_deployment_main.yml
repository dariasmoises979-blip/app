########################################
# ğŸš€ WORKFLOW: Deploy to Kubernetes (GCP)
# Se ejecuta cuando hay push a main
# 04-deploy-kubernetes.yml v6.0 - USA IMAGE-INFO DEL BUILD
########################################

name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

permissions:
  actions: read
  contents: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: OBTENER INFORMACIÃ“N DE LA IMAGEN DESDE EL REPO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  get-image-info:
    name: ğŸ“¥ Get Image Info from Repository
    runs-on: ubuntu-latest
    
    outputs:
      image_name: ${{ steps.load_info.outputs.image_name }}
      docker_image: ${{ steps.load_info.outputs.docker_image }}
      gcp_project_id: ${{ steps.load_info.outputs.gcp_project_id }}
      gcp_region: ${{ steps.load_info.outputs.gcp_region }}
      artifact_registry: ${{ steps.load_info.outputs.artifact_registry }}
      tag_pre: ${{ steps.load_info.outputs.tag_pre }}
      tag_staging: ${{ steps.load_info.outputs.tag_staging }}
      tag_pro: ${{ steps.load_info.outputs.tag_pro }}
      short_sha: ${{ steps.load_info.outputs.short_sha }}
      full_image_pre: ${{ steps.load_info.outputs.full_image_pre }}
      full_image_staging: ${{ steps.load_info.outputs.full_image_staging }}
      full_image_pro: ${{ steps.load_info.outputs.full_image_pro }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“‹ Load and validate image information
        id: load_info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ LOADING IMAGE INFORMATION FROM REPOSITORY (GCP)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¿ Deploy Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Deploy Commit: ${{ github.sha }}"
          echo ""
          
          # Verificar que existe el archivo
          if [ ! -f ".github/build-info/image-info.env" ]; then
            echo "âŒ ERROR: .github/build-info/image-info.env not found!"
            echo "   Make sure the build workflow (03-ci-cd.yml) completed successfully"
            echo "   and committed the image-info.env file."
            exit 1
          fi
          
          echo "âœ… image-info.env found, loading variables..."
          echo ""
          
          # Cargar variables desde el archivo
          source .github/build-info/image-info.env
          
          # Validar variables crÃ­ticas
          if [ -z "$SHORT_SHA" ] || [ -z "$TAG_PRE" ] || [ -z "$TAG_STAGING" ] || [ -z "$TAG_PRO" ]; then
            echo "âŒ ERROR: Missing critical variables in image-info.env"
            cat .github/build-info/image-info.env
            exit 1
          fi
          
          # Exportar outputs usando las variables del archivo de build
          echo "image_name=${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY}/${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "docker_image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "gcp_project_id=${GCP_PROJECT_ID}" >> $GITHUB_OUTPUT
          echo "gcp_region=${GCP_REGION}" >> $GITHUB_OUTPUT
          echo "artifact_registry=${ARTIFACT_REGISTRY}" >> $GITHUB_OUTPUT
          echo "tag_pre=${TAG_PRE}" >> $GITHUB_OUTPUT
          echo "tag_staging=${TAG_STAGING}" >> $GITHUB_OUTPUT
          echo "tag_pro=${TAG_PRO}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_image_pre=${FULL_IMAGE_PRE}" >> $GITHUB_OUTPUT
          echo "full_image_staging=${FULL_IMAGE_STAGING}" >> $GITHUB_OUTPUT
          echo "full_image_pro=${FULL_IMAGE_PRO}" >> $GITHUB_OUTPUT
          
          echo "âœ… Image information loaded from repository:"
          echo "   â€¢ GCP Project: ${GCP_PROJECT_ID}"
          echo "   â€¢ Region: ${GCP_REGION}"
          echo "   â€¢ Registry: ${ARTIFACT_REGISTRY}"
          echo "   â€¢ Image Name: ${IMAGE_NAME}"
          echo "   â€¢ Build SHA: ${SHORT_SHA} (from build workflow)"
          echo "   â€¢ Build Commit: ${COMMIT_SHA}"
          echo "   â€¢ Build Date: ${BUILD_DATE}"
          echo "   â€¢ Triggered by: ${TRIGGERED_BY}"
          echo ""
          echo "ğŸ·ï¸  Tags from build:"
          echo "   â€¢ PRE:     ${TAG_PRE}"
          echo "   â€¢ STAGING: ${TAG_STAGING}"
          echo "   â€¢ PRO:     ${TAG_PRO}"
          echo ""
          echo "ğŸ“¦ Full images:"
          echo "   â€¢ PRE:     ${FULL_IMAGE_PRE}"
          echo "   â€¢ STAGING: ${FULL_IMAGE_STAGING}"
          echo "   â€¢ PRO:     ${FULL_IMAGE_PRO}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: DEPLOY A PRE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pre:
    name: ğŸš€ Deploy to PRE
    needs: get-image-info
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      gcp_project_id: ${{ needs.get-image-info.outputs.gcp_project_id }}
      gcp_region: ${{ needs.get-image-info.outputs.gcp_region }}
      artifact_registry: ${{ needs.get-image-info.outputs.artifact_registry }}
      environment: pre
      image_tag: ${{ needs.get-image-info.outputs.tag_pre }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: DEPLOY A STAGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: ğŸš€ Deploy to STAGING
    needs: [get-image-info, deploy-pre]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      gcp_project_id: ${{ needs.get-image-info.outputs.gcp_project_id }}
      gcp_region: ${{ needs.get-image-info.outputs.gcp_region }}
      artifact_registry: ${{ needs.get-image-info.outputs.artifact_registry }}
      environment: staging
      image_tag: ${{ needs.get-image-info.outputs.tag_staging }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: DEPLOY A PRO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-pro:
    name: ğŸš€ Deploy to PRO
    needs: [get-image-info, deploy-staging]
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      project_name: ${{ github.event.repository.name }}
      docker_image: ${{ needs.get-image-info.outputs.docker_image }}
      gcp_project_id: ${{ needs.get-image-info.outputs.gcp_project_id }}
      gcp_region: ${{ needs.get-image-info.outputs.gcp_region }}
      artifact_registry: ${{ needs.get-image-info.outputs.artifact_registry }}
      environment: pro
      image_tag: ${{ needs.get-image-info.outputs.tag_pro }}
      target_branch: main
    secrets:
      GH_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: RESUMEN FINAL DEL DEPLOYMENT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: 
      - get-image-info
      - deploy-pre
      - deploy-staging
      - deploy-pro
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Generate deployment summary
        run: |
          echo "## ğŸ“Š Kubernetes Deployment Summary (GCP)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”€ Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build SHA Used**: \`${{ needs.get-image-info.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Message**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### â˜ï¸ GCP Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: \`${{ needs.get-image-info.outputs.gcp_project_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: \`${{ needs.get-image-info.outputs.gcp_region }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ needs.get-image-info.outputs.artifact_registry }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Image**: \`${{ needs.get-image-info.outputs.image_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ³ Docker Images Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Image Tag | Status | Files Updated |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          
          PRE_K8S="${{ needs.deploy-pre.outputs.k8s_files_count || '0' }}"
          PRE_HELM="${{ needs.deploy-pre.outputs.helm_files_count || '0' }}"
          PRE_TOTAL=$((PRE_K8S + PRE_HELM))
          echo "| PRE | \`${{ needs.get-image-info.outputs.tag_pre }}\` | ${{ needs.deploy-pre.result }} | ${PRE_TOTAL} (K8s: ${PRE_K8S}, Helm: ${PRE_HELM}) |" >> $GITHUB_STEP_SUMMARY
          
          STG_K8S="${{ needs.deploy-staging.outputs.k8s_files_count || '0' }}"
          STG_HELM="${{ needs.deploy-staging.outputs.helm_files_count || '0' }}"
          STG_TOTAL=$((STG_K8S + STG_HELM))
          echo "| STAGING | \`${{ needs.get-image-info.outputs.tag_staging }}\` | ${{ needs.deploy-staging.result }} | ${STG_TOTAL} (K8s: ${STG_K8S}, Helm: ${STG_HELM}) |" >> $GITHUB_STEP_SUMMARY
          
          PRO_K8S="${{ needs.deploy-pro.outputs.k8s_files_count || '0' }}"
          PRO_HELM="${{ needs.deploy-pro.outputs.helm_files_count || '0' }}"
          PRO_TOTAL=$((PRO_K8S + PRO_HELM))
          echo "| PRO | \`${{ needs.get-image-info.outputs.tag_pro }}\` | ${{ needs.deploy-pro.result }} | ${PRO_TOTAL} (K8s: ${PRO_K8S}, Helm: ${PRO_HELM}) |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‹ Full Images Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **PRE**: \`${{ needs.get-image-info.outputs.full_image_pre }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **STAGING**: \`${{ needs.get-image-info.outputs.full_image_staging }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PRO**: \`${{ needs.get-image-info.outputs.full_image_pro }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‹ Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Project**: \`${{ github.event.repository.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image**: \`${{ needs.get-image-info.outputs.docker_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Commit SHA**: \`${{ needs.get-image-info.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GCP Artifact Registry](https://console.cloud.google.com/artifacts/docker/${{ needs.get-image-info.outputs.gcp_project_id }}/${{ needs.get-image-info.outputs.gcp_region }}/${{ needs.get-image-info.outputs.artifact_registry }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Build Commit ${{ needs.get-image-info.outputs.short_sha }}](https://github.com/${{ github.repository }}/commit/${{ needs.get-image-info.outputs.short_sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Estado general
          if [[ "${{ needs.deploy-pre.result }}" == "success" ]] && \
             [[ "${{ needs.deploy-staging.result }}" == "success" ]] && \
             [[ "${{ needs.deploy-pro.result }}" == "success" ]]; then
            echo "### âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "All environments have been updated successfully!" >> $GITHUB_STEP_SUMMARY
            
            TOTAL_FILES=$((PRE_TOTAL + STG_TOTAL + PRO_TOTAL))
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Total files updated across all environments: ${TOTAL_FILES}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ¯ **All manifests are now using images built from commit \`${{ needs.get-image-info.outputs.short_sha }}\`**" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Deployment Incomplete" >> $GITHUB_STEP_SUMMARY
            echo "Some environments failed or were skipped. Check the logs above." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Console Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š KUBERNETES DEPLOYMENT SUMMARY (GCP)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”€ Deploy Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Deploy Commit: ${{ github.sha }}"
          echo "ğŸ—ï¸  Build SHA Used: ${{ needs.get-image-info.outputs.short_sha }}"
          echo ""
          echo "ğŸ“¦ Project: ${{ github.event.repository.name }}"
          echo "â˜ï¸  GCP Project: ${{ needs.get-image-info.outputs.gcp_project_id }}"
          echo "ğŸ“ Region: ${{ needs.get-image-info.outputs.gcp_region }}"
          echo "ğŸ—„ï¸  Registry: ${{ needs.get-image-info.outputs.artifact_registry }}"
          echo "ğŸ³ Docker Image: ${{ needs.get-image-info.outputs.docker_image }}"
          echo ""
          echo "ğŸ“‹ Deployment Status:"
          echo "   â€¢ PRE:     ${{ needs.deploy-pre.result }} (K8s: ${{ needs.deploy-pre.outputs.k8s_files_count || '0' }}, Helm: ${{ needs.deploy-pre.outputs.helm_files_count || '0' }})"
          echo "   â€¢ STAGING: ${{ needs.deploy-staging.result }} (K8s: ${{ needs.deploy-staging.outputs.k8s_files_count || '0' }}, Helm: ${{ needs.deploy-staging.outputs.helm_files_count || '0' }})"
          echo "   â€¢ PRO:     ${{ needs.deploy-pro.result }} (K8s: ${{ needs.deploy-pro.outputs.k8s_files_count || '0' }}, Helm: ${{ needs.deploy-pro.outputs.helm_files_count || '0' }})"
          echo ""
          echo "ğŸ·ï¸  Tags Used (from build ${{ needs.get-image-info.outputs.short_sha }}):"
          echo "   â€¢ PRE:     ${{ needs.get-image-info.outputs.tag_pre }}"
          echo "   â€¢ STAGING: ${{ needs.get-image-info.outputs.tag_staging }}"
          echo "   â€¢ PRO:     ${{ needs.get-image-info.outputs.tag_pro }}"
          echo ""
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ• Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

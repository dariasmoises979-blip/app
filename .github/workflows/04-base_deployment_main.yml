########################################
# ðŸš€ CI/CD PIPELINE COMPLETO
# Build de imagen Docker + GitOps deployment con ArgoCD
# ðŸ†• USA EL TAG GENERADO POR EL BUILD
#04-base_deployment_main.yml
########################################

name: CI/CD Pipeline

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  # Permitir ejecuciÃ³n manual con selecciÃ³n de entorno
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - qa
          - staging
          - pre
          - prod
      force_build:
        description: 'Force rebuild even if no changes'
        required: false
        type: boolean
        default: false

# Prevenir ejecuciones concurrentes por rama
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸŽ¯ JOB 1: DETERMINAR ENTORNO BASADO EN LA RAMA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  determine-environment:
    name: ðŸŽ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
      
    steps:
      - name: Determine Environment from Branch
        id: env
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¯ DETERMINING DEPLOYMENT ENVIRONMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Si es workflow_dispatch, usar el input del usuario
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            SHOULD_DEPLOY="true"
            echo "ðŸ–±ï¸  Manual trigger detected"
            echo "ðŸŒ Selected environment: ${ENVIRONMENT}"
          
          # Si es pull_request, solo build sin deploy
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            ENVIRONMENT="dev"
            SHOULD_DEPLOY="false"
            echo "ðŸ”€ Pull Request detected"
            echo "ðŸ”¨ Will build image but NOT deploy"
          
          # Determinar por rama
          else
            BRANCH="${{ github.ref_name }}"
            echo "ðŸŒ¿ Branch: ${BRANCH}"
            
            case "${BRANCH}" in
              main|master)
                ENVIRONMENT="prod"
                SHOULD_DEPLOY="true"
                ;;
              release/*)
                ENVIRONMENT="pre"
                SHOULD_DEPLOY="true"
                ;;
              staging)
                ENVIRONMENT="staging"
                SHOULD_DEPLOY="true"
                ;;
              develop|development)
                ENVIRONMENT="dev"
                SHOULD_DEPLOY="true"
                ;;
              *)
                ENVIRONMENT="dev"
                SHOULD_DEPLOY="false"
                echo "âš ï¸  Feature branch detected - will build but not deploy"
                ;;
            esac
          fi
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "should_deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸ“‹ Results:"
          echo "   â€¢ Environment: ${ENVIRONMENT}"
          echo "   â€¢ Should Deploy: ${SHOULD_DEPLOY}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ³ JOB 2: BUILD & PUSH IMAGEN DOCKER
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # build-docker-image:
  #   name: ðŸ³ Build Docker Image
  #   needs: determine-environment
  #   uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image.yml@main
  #   with:
  #       docker_image: mi-aplicacion
  #       dockerhub_username: dariasmoises979
  #       environment: qa
        
  #       # ConfiguraciÃ³n del repo externo
  #       external_repo: dariasmoises979-blip/app
  #       external_repo_ref: main
  #       external_repo_path: ./app-repo
        
  #       # Rutas del build
  #       dockerfile_path: ./app-repo/local/Dockerfile
  #       build_context: ./app-repo                    # âœ… Sin barra final (correcto)
        
  #   secrets:
  #       DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  #       EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}
  

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“Š JOB 3: MOSTRAR TAG GENERADO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  show-build-output:
    name: ðŸ“Š Show Build Output
    needs: determine-environment
    runs-on: ubuntu-latest
    steps:
      - name: Display Build Output
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š BUILD OUTPUT INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ·ï¸  Primary Tag: ${{ needs.build-docker-image.outputs.image_tag }}"
          echo "ðŸ“¦ Full Image: ${{ needs.build-docker-image.outputs.full_image }}"
          echo "ðŸ”— Short SHA: ${{ needs.build-docker-image.outputs.short_sha }}"
          echo "ðŸ“‹ All Tags: ${{ needs.build-docker-image.outputs.all_tags }}"
          echo ""
          echo "ðŸŽ¯ This tag will be used for deployment:"
          echo "   ${{ needs.build-docker-image.outputs.image_tag }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸš€ JOB 4: DESPLIEGUE GITOPS (DEV & STAGING - AUTOMÃTICO)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-auto:
    name: ðŸš€ Deploy to ${{ needs.determine-environment.outputs.environment }}
    needs: 
      - determine-environment
    if: |
      needs.determine-environment.outputs.should_deploy == 'true' && 
      (needs.determine-environment.outputs.environment == 'dev' || 
       needs.determine-environment.outputs.environment == 'staging')
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: ${{ needs.determine-environment.outputs.environment }}
      # ðŸŽ¯ USAR EL TAG GENERADO POR EL BUILD
      image_tag: ${{ needs.build-docker-image.outputs.image_tag }}
      dockerhub_username: "tu-usuario"  # ðŸ‘ˆ Debe coincidir con el de build
      docker_image: "mi-aplicacion"      # ðŸ‘ˆ Debe coincidir con el de build
      manifests_path: "kubernetes"              # ðŸ‘ˆ Ruta a tus manifiestos
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps]"
    secrets: inherit

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ” JOB 5: DESPLIEGUE GITOPS (PRE & PROD - MANUAL)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-manual:
    name: ðŸ” Deploy to ${{ needs.determine-environment.outputs.environment }} (Requires Approval)
    needs: 
      - determine-environment
    if: |
      needs.determine-environment.outputs.should_deploy == 'true' && 
      (needs.determine-environment.outputs.environment == 'pre' || 
       needs.determine-environment.outputs.environment == 'prod')
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
    with:
      environment: ${{ needs.determine-environment.outputs.environment }}
      # ðŸŽ¯ USAR EL TAG GENERADO POR EL BUILD
      image_tag: ${{ needs.build-docker-image.outputs.image_tag }}
      dockerhub_username: "tu-usuario"
      docker_image: "mi-aplicacion"
      manifests_path: "kubernetes"
      manifest_file_pattern: "*.yaml"
      commit_message_prefix: "[GitOps]"
      requires_approval: true
    secrets: inherit



  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ðŸ“Š JOB 6: RESUMEN FINAL
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Pipeline Summary
    needs:
      - determine-environment
      - show-build-output
      - deploy-auto
      - deploy-manual
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Pipeline Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š CI/CD PIPELINE SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”— Event: ${{ github.event_name }}"
          echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ðŸŒ Environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "ðŸš€ Should Deploy: ${{ needs.determine-environment.outputs.should_deploy }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ðŸ• Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ðŸ³ Docker Build:"
          echo "   â€¢ Status: ${{ needs.build-docker-image.result }}"
          echo "   â€¢ Image Tag: ${{ needs.build-docker-image.outputs.image_tag }}"
          echo "   â€¢ Full Image: ${{ needs.build-docker-image.outputs.full_image }}"
          echo ""
          echo "ðŸ“‹ Job Results:"
          echo "   â€¢ Determine Env: ${{ needs.determine-environment.result }}"
          echo "   â€¢ Build: ${{ needs.build-docker-image.result }}"
          echo "   â€¢ Show Output: ${{ needs.show-build-output.result }}"
          echo "   â€¢ Deploy Auto: ${{ needs.deploy-auto.result || 'skipped' }}"
          echo "   â€¢ Deploy Manual: ${{ needs.deploy-manual.result || 'skipped' }}"
          echo ""
          
          if [ "${{ needs.determine-environment.outputs.should_deploy }}" == "true" ]; then
            echo "âœ… Deployment completed to: ${{ needs.determine-environment.outputs.environment }}"
            echo ""
            echo "ðŸ”„ Next Steps:"
            echo "   1. Check ArgoCD for sync status"
            echo "   2. Monitor application health"
            echo "   3. Verify deployment in target environment"
            echo ""
            echo "ðŸŽ¯ Deployed Image Tag:"
            echo "   ${{ needs.build-docker-image.outputs.image_tag }}"
          else
            echo "â„¹ï¸  Image built but not deployed (PR or feature branch)"
            echo ""
            echo "ðŸ³ Built Image:"
            echo "   ${{ needs.build-docker-image.outputs.full_image }}"
          fi
          
          echo ""
          echo "ðŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check for Failures
        if: |
          needs.build-docker-image.result == 'failure' ||
          needs.deploy-auto.result == 'failure' ||
          needs.deploy-manual.result == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ PIPELINE FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  One or more jobs failed. Please check the logs above."
          echo ""
          echo "ðŸ” Failed Jobs:"
          [ "${{ needs.build-docker-image.result }}" == "failure" ] && echo "   â€¢ Build Docker Image"
          [ "${{ needs.deploy-auto.result }}" == "failure" ] && echo "   â€¢ Deploy Auto"
          [ "${{ needs.deploy-manual.result }}" == "failure" ] && echo "   â€¢ Deploy Manual"
          echo ""
          echo "ðŸ”— Workflow Run:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

#           # .github/workflows/04-base_deployment_main.yml
# name: Deploy Updated Images

# on:
#   workflow_run:
#     workflows: ["Build and Push Docker Image"]
#     types:
#       - completed

# jobs:
#   deploy:
#     if: ${{ github.event.workflow_run.conclusion == 'success' }}
#     runs-on: ubuntu-latest

#     steps:
#       - name: Download artifact from previous workflow
#         uses: actions/download-artifact@v4
#         with:
#           name: image-info
#           run-id: ${{ github.event.workflow_run.id }}
#           path: ./data

#       - name: Read image info
#         id: read
#         run: |
#           source ./data/image-info.env
#           echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
#           echo "tag_pre=${TAG_PRE}" >> $GITHUB_OUTPUT
#           echo "tag_staging=${TAG_STAGING}" >> $GITHUB_OUTPUT
#           echo "tag_prod=${TAG_PRO}" >> $GITHUB_OUTPUT

#       - name: Call GitOps reusable for staging
#         uses: dariasmoises979-blip/pipeline-build/.github/workflows/deployment-gitops.yml@main
#         with:
#           environment: staging
#           image_tag: ${{ steps.read.outputs.tag_staging }}
#           dockerhub_username: dariasmoises979
#           docker_image: ${{ steps.read.outputs.image_name }}
#         secrets: inherit

########################################
# ğŸ”„ WORKFLOW BASE: Find Latest Image & Update K8s
# Busca la Ãºltima imagen Docker en Docker Hub y
# actualiza los manifiestos de Kubernetes automÃ¡ticamente
# (NO construye imÃ¡genes nuevas)
########################################

name: Update K8s from Docker Hub
permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write
  
# ğŸ¯ Triggers del workflow
on:
  push:
    branches:
      - main
      - 'integration'  # <-- agregar para detectar pushes desde integration
    paths:
      - 'src/**'
      - 'kubernetes/**'
      - '.github/workflows/**'
  
  pull_request:
    branches:
      - main
    # Esto permite PRs desde integration a main
    # Puedes agregar otras ramas si quieres
    paths:
      - 'src/**'
      - 'kubernetes/**'

  
  # EjecuciÃ³n manual con parÃ¡metros
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de deployment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - pre
          - pro
        default: 'dev'
      create_pr:
        description: 'Crear PR en lugar de commit directo'
        required: false
        type: boolean
        default: false
      tag_pattern:
        description: 'PatrÃ³n de tag a buscar (ej: pro-*, staging-*). Deja vacÃ­o para usar entorno-*'
        required: false
        type: string
        default: ''
  
  # EjecuciÃ³n programada (cada hora para verificar nuevas imÃ¡genes)
  #schedule:
  #  - cron: '0 * * * *'  # Cada hora en punto

# âš™ï¸ Variables de entorno globales
env:
  # ğŸ³ ConfiguraciÃ³n de Docker Hub
  DOCKERHUB_USERNAME: tu-usuario-dockerhub  # âš ï¸ CAMBIAR POR TU USUARIO
  DOCKER_IMAGE_NAME: mi-aplicacion           # âš ï¸ CAMBIAR POR TU IMAGEN
  
  # ğŸ“ ConfiguraciÃ³n de rutas
  K8S_MANIFESTS_PATH: kubernetes/entornos
  
  # ğŸ”§ ConfiguraciÃ³n de Git
  GIT_USER_NAME: GitHub Actions Bot
  GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ¯ JOB 1: DETERMINAR ENTORNO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  determine-environment:
    name: Determine Deployment Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set_env.outputs.environment }}
      should_deploy: ${{ steps.set_env.outputs.should_deploy }}
      tag_pattern: ${{ steps.set_env.outputs.tag_pattern }}
    
    steps:
      - name: Determine environment from branch
        id: set_env
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ DETERMINANDO ENTORNO DE DEPLOYMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Si es workflow_dispatch, usar el input
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            TAG_PATTERN="${{ github.event.inputs.tag_pattern }}"
            SHOULD_DEPLOY="true"
            echo "ğŸ“ Modo: Manual (workflow_dispatch)"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            # En schedule, actualizar todos los entornos (puedes cambiar esto)
            ENVIRONMENT="pro"
            TAG_PATTERN=""
            SHOULD_DEPLOY="true"
            echo "â° Modo: Scheduled (cron)"
          else
            # Determinar entorno segÃºn la rama
            BRANCH_NAME="${{ github.ref_name }}"
            echo "ğŸŒ¿ Rama: ${BRANCH_NAME}"
            
            case "${BRANCH_NAME}" in
              main|master)
                ENVIRONMENT="pro"
                SHOULD_DEPLOY="true"
                ;;
              release/*)
                ENVIRONMENT="pre"
                SHOULD_DEPLOY="true"
                ;;
              develop)
                ENVIRONMENT="staging"
                SHOULD_DEPLOY="true"
                ;;
              *)
                ENVIRONMENT="dev"
                SHOULD_DEPLOY="false"
                echo "â„¹ï¸  Ramas feature no actualizan K8s automÃ¡ticamente"
                ;;
            esac
            TAG_PATTERN=""
          fi
          
          # Si no hay tag_pattern definido, usar el entorno como prefijo
          if [[ -z "${TAG_PATTERN}" ]]; then
            TAG_PATTERN="${ENVIRONMENT}-"
          fi
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "should_deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          echo "tag_pattern=${TAG_PATTERN}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Entorno determinado: ${ENVIRONMENT}"
          echo "ğŸ” PatrÃ³n de bÃºsqueda: ${TAG_PATTERN}*"
          echo "ğŸš€ Debe deployar: ${SHOULD_DEPLOY}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ” JOB 2: BUSCAR ÃšLTIMA IMAGEN Y ACTUALIZAR K8S
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  find-and-update:
    name: Find Latest Image & Update K8s
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    uses: ./.github/workflows/reusable-find-update-k8s.yml
    with:
      docker_image: ${{ vars.DOCKER_IMAGE_NAME || 'mi-aplicacion' }}
      dockerhub_username: ${{ vars.DOCKERHUB_USERNAME || 'tu-usuario' }}
      environment: ${{ needs.determine-environment.outputs.environment }}
      k8s_manifests_path: ${{ vars.K8S_MANIFESTS_PATH || 'kubernetes/entornos' }}
      git_user_name: ${{ vars.GIT_USER_NAME || 'GitHub Actions Bot' }}
      git_user_email: ${{ vars.GIT_USER_EMAIL || 'github-actions[bot]@users.noreply.github.com' }}
      create_pr: ${{ github.event.inputs.create_pr == 'true' || github.event_name == 'pull_request' }}
      tag_pattern: ${{ needs.determine-environment.outputs.tag_pattern }}
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 3: DEPLOYMENT SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deployment-summary:
    name: Deployment Summary
    needs: [determine-environment, find-and-update]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE ACTUALIZACIÃ“N K8S"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ¯ InformaciÃ³n General:"
          echo "   â€¢ Entorno: ${{ needs.determine-environment.outputs.environment }}"
          echo "   â€¢ Rama: ${{ github.ref_name }}"
          echo "   â€¢ Actor: ${{ github.actor }}"
          echo "   â€¢ Evento: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "   â€¢ Tipo: EjecuciÃ³n programada (cron)"
          fi
          echo ""
          echo "ğŸ” BÃºsqueda de Imagen:"
          echo "   â€¢ PatrÃ³n: ${{ needs.determine-environment.outputs.tag_pattern }}*"
          echo "   â€¢ Repositorio: ${{ vars.DOCKERHUB_USERNAME || 'tu-usuario' }}/${{ vars.DOCKER_IMAGE_NAME || 'mi-aplicacion' }}"
          echo "   â€¢ Docker Hub: https://hub.docker.com/r/${{ vars.DOCKERHUB_USERNAME || 'tu-usuario' }}/${{ vars.DOCKER_IMAGE_NAME || 'mi-aplicacion' }}/tags"
          echo ""
          echo "ğŸ”„ ActualizaciÃ³n de K8s:"
          echo "   â€¢ Estado: ${{ needs.find-and-update.result }}"
          echo "   â€¢ Ruta: ${{ vars.K8S_MANIFESTS_PATH || 'kubernetes/entornos' }}"
          echo "   â€¢ Modo: ${{ github.event.inputs.create_pr == 'true' && 'Pull Request' || 'Commit Directo' }}"
          echo ""
          echo "âœ… Estado General:"
          if [[ "${{ needs.find-and-update.result }}" == "success" ]]; then
            echo "   ğŸ‰ ACTUALIZACIÃ“N COMPLETADA EXITOSAMENTE"
          elif [[ "${{ needs.find-and-update.result }}" == "skipped" ]]; then
            echo "   â­ï¸  ACTUALIZACIÃ“N OMITIDA"
          else
            echo "   âš ï¸  ACTUALIZACIÃ“N CON PROBLEMAS - Revisar logs"
          fi
          echo ""
          echo "ğŸ”— Enlaces:"
          echo "   â€¢ Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "   â€¢ Repositorio: ${{ github.server_url }}/${{ github.repository }}"
          if [[ "${{ github.event_name }}" != "schedule" ]]; then
            echo "   â€¢ Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # NotificaciÃ³n de error si algo fallÃ³
      - name: Report failure
        if: needs.find-and-update.result == 'failure'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ACTUALIZACIÃ“N FALLIDA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âš ï¸  Posibles causas:"
          echo "   â€¢ No se encontraron imÃ¡genes en Docker Hub con el patrÃ³n especificado"
          echo "   â€¢ Credenciales de Docker Hub incorrectas o token expirado"
          echo "   â€¢ Permisos insuficientes para actualizar manifiestos"
          echo "   â€¢ Manifiestos K8s con formato incorrecto"
          echo "   â€¢ Token GH_PAT sin permisos adecuados (repo, workflow)"
          echo "   â€¢ Directorio de manifiestos no existe"
          echo ""
          echo "ğŸ” Pasos de debug:"
          echo "   1. Verificar que existen imÃ¡genes en Docker Hub:"
          echo "      https://hub.docker.com/r/${{ vars.DOCKERHUB_USERNAME || 'tu-usuario' }}/${{ vars.DOCKER_IMAGE_NAME || 'mi-aplicacion' }}/tags"
          echo "   2. Verificar patrÃ³n de bÃºsqueda: '${{ needs.determine-environment.outputs.tag_pattern }}*'"
          echo "   3. Revisar logs del job 'find-and-update'"
          echo "   4. Verificar secrets: DOCKERHUB_TOKEN y GH_PAT"
          echo "   5. Verificar que el directorio '${{ vars.K8S_MANIFESTS_PATH || 'kubernetes/entornos' }}' existe"
          echo "   6. Verificar formato de manifiestos (image: usuario/app:tag)"
          echo ""
          echo "ğŸ”— Ver workflow completo:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
# 01-feature-workflow.yml
name: Feature Pipeline - Tests & Merge to Dev

on:
  push:
    branches: 
      - feature/**

permissions:
  actions: read
  contents: write
  pull-requests: write
  checks: write
  security-events: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: UNIT & INTEGRATION TESTS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ðŸ§ª Run Tests & Quality Analysis
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/test.yml@main
    with:
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      projectBaseDir: "./pipeline-build"
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: SQL QUERY ANALYSIS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze-queries:
    name: ðŸ” Analyze Database Queries
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ðŸ§° Install SQL analysis tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§° INSTALLING SQL ANALYSIS TOOLS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          pip install --upgrade pip
          pip install sqlfluff sqlparse
          
          echo "âœ… Tools installed successfully"
          echo "   - sqlfluff: SQL linter"
          echo "   - sqlparse: SQL formatter & parser"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ” Scan for SQL queries
        id: scan
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” SCANNING PROJECT FOR SQL QUERIES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Buscar archivos con queries SQL
          SQL_FILES=$(find . -type f \( -name "*.sql" -o -name "*.py" -o -name "*.js" -o -name "*.java" \) | grep -v node_modules | grep -v .git || echo "")
          
          if [ -z "${SQL_FILES}" ]; then
            echo "âš ï¸  No SQL files found"
            echo "query_count=0" >> $GITHUB_OUTPUT
          else
            QUERY_COUNT=$(echo "${SQL_FILES}" | wc -l)
            echo "âœ… Found ${QUERY_COUNT} files to analyze"
            echo "${SQL_FILES}" | head -10
            echo "query_count=${QUERY_COUNT}" >> $GITHUB_OUTPUT
          fi
          
          # Buscar patrones SQL en el cÃ³digo
          echo ""
          echo "ðŸ“Š SQL Pattern Analysis:"
          SELECT_COUNT=$(grep -ri "SELECT\s" . --include="*.py" --include="*.sql" --include="*.js" 2>/dev/null | wc -l || echo "0")
          INSERT_COUNT=$(grep -ri "INSERT\s" . --include="*.py" --include="*.sql" --include="*.js" 2>/dev/null | wc -l || echo "0")
          UPDATE_COUNT=$(grep -ri "UPDATE\s" . --include="*.py" --include="*.sql" --include="*.js" 2>/dev/null | wc -l || echo "0")
          DELETE_COUNT=$(grep -ri "DELETE\s" . --include="*.py" --include="*.sql" --include="*.js" 2>/dev/null | wc -l || echo "0")
          JOIN_COUNT=$(grep -ri "JOIN\s" . --include="*.py" --include="*.sql" --include="*.js" 2>/dev/null | wc -l || echo "0")
          
          echo "   SELECT queries: ${SELECT_COUNT}"
          echo "   INSERT queries: ${INSERT_COUNT}"
          echo "   UPDATE queries: ${UPDATE_COUNT}"
          echo "   DELETE queries: ${DELETE_COUNT}"
          echo "   JOIN operations: ${JOIN_COUNT}"
          
          echo "select_count=${SELECT_COUNT}" >> $GITHUB_OUTPUT
          echo "insert_count=${INSERT_COUNT}" >> $GITHUB_OUTPUT
          echo "update_count=${UPDATE_COUNT}" >> $GITHUB_OUTPUT
          echo "delete_count=${DELETE_COUNT}" >> $GITHUB_OUTPUT
          echo "join_count=${JOIN_COUNT}" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ§ª Lint SQL files with SQLFluff
        if: steps.scan.outputs.query_count != '0'
        continue-on-error: true
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§ª RUNNING SQLFLUFF LINTER"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Configurar SQLFluff
          cat > .sqlfluff << EOF
          [sqlfluff]
          dialect = postgres
          templater = raw
          max_line_length = 120
          
          [sqlfluff:rules]
          capitalisation_policy = upper
          EOF
          
          # Ejecutar linter en archivos .sql
          if ls *.sql 1> /dev/null 2>&1; then
            sqlfluff lint . --dialect postgres || echo "âš ï¸  Linting issues found (non-blocking)"
          else
            echo "â„¹ï¸  No .sql files to lint"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ”Ž Detect potential performance issues
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”Ž DETECTING PERFORMANCE ANTI-PATTERNS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ISSUES_FOUND=0
          
          # Detectar SELECT *
          SELECT_STAR=$(grep -ri "SELECT\s*\*" . --include="*.py" --include="*.sql" --include="*.js" 2>/dev/null | wc -l || echo "0")
          if [ "${SELECT_STAR}" -gt 0 ]; then
            echo "âš ï¸  Found ${SELECT_STAR} instances of 'SELECT *' (consider specifying columns)"
            ISSUES_FOUND=$((ISSUES_FOUND + SELECT_STAR))
          fi
          
          # Detectar N+1 patterns (queries en loops)
          N_PLUS_ONE=$(grep -riE "(for|while).*\.(query|execute|get)" . --include="*.py" 2>/dev/null | wc -l || echo "0")
          if [ "${N_PLUS_ONE}" -gt 0 ]; then
            echo "âš ï¸  Found ${N_PLUS_ONE} potential N+1 query patterns (queries in loops)"
            ISSUES_FOUND=$((ISSUES_FOUND + N_PLUS_ONE))
          fi
          
          # Detectar missing WHERE clauses
          NO_WHERE=$(grep -ri "DELETE FROM\|UPDATE" . --include="*.sql" --include="*.py" | grep -v "WHERE" 2>/dev/null | wc -l || echo "0")
          if [ "${NO_WHERE}" -gt 0 ]; then
            echo "âš ï¸  Found ${NO_WHERE} UPDATE/DELETE without WHERE clause (potential data loss risk)"
            ISSUES_FOUND=$((ISSUES_FOUND + NO_WHERE))
          fi
          
          # Detectar subconsultas sin lÃ­mite
          UNLIMITED_SUBQUERIES=$(grep -ri "SELECT.*\(SELECT" . --include="*.sql" | grep -v "LIMIT" 2>/dev/null | wc -l || echo "0")
          if [ "${UNLIMITED_SUBQUERIES}" -gt 0 ]; then
            echo "âš ï¸  Found ${UNLIMITED_SUBQUERIES} subqueries without LIMIT"
            ISSUES_FOUND=$((ISSUES_FOUND + UNLIMITED_SUBQUERIES))
          fi
          
          if [ "${ISSUES_FOUND}" -eq 0 ]; then
            echo "âœ… No obvious performance anti-patterns detected"
          else
            echo ""
            echo "ðŸ“Š Total potential issues: ${ISSUES_FOUND}"
            echo "ðŸ’¡ Consider reviewing these patterns for optimization"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ“Š Generate SQL analysis summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š SQL QUERY ANALYSIS SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Files analyzed: ${{ steps.scan.outputs.query_count }}"
          echo "SELECT queries: ${{ steps.scan.outputs.select_count }}"
          echo "INSERT queries: ${{ steps.scan.outputs.insert_count }}"
          echo "UPDATE queries: ${{ steps.scan.outputs.update_count }}"
          echo "DELETE queries: ${{ steps.scan.outputs.delete_count }}"
          echo "JOIN operations: ${{ steps.scan.outputs.join_count }}"
          echo ""
          echo "âœ… SQL analysis completed successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: AUTO-MERGE TO DEV
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  merge-to-dev:
    name: ðŸ”€ Auto-merge to Dev
    needs: [test, analyze-queries]
    if: startsWith(github.ref_name, 'feature/') && success()
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/auto-merge.yml@main
    with:
      source_branch: ${{ github.ref_name }}
      target_branch: 'dev'
      use_fast_forward: false
      merge_message: 'ðŸ”€ Auto-merge from ${{ github.ref_name }} after successful tests'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: CREATE PULL REQUEST TO QA
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-pr-to-qa:
    name: ðŸ“ Create PR from Dev to QA
    needs: merge-to-dev
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main
    with:
      source_branch: 'dev'
      target_branch: 'qa'
      pr_title: 'ðŸš€ Deploy DEV to QA Environment'
      environment: 'qa'
      labels: 'automated,deployment,qa,dev'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: NOTIFICATION & CONFIRMATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-success:
    name: ðŸŽ‰ Workflow Success Notification
    needs: [test, analyze-queries, merge-to-dev, create-pr-to-qa]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: ðŸŽŠ Success notification
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ FEATURE WORKFLOW COMPLETED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Feature branch: ${{ github.ref_name }}"
          echo "âœ… Tests: PASSED"
          echo "âœ… SQL Analysis: COMPLETED"
          echo "âœ… Merged to: dev"
          echo "âœ… PR Created: dev â†’ qa"
          echo ""
          echo "ðŸ”— Workflow URL:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ðŸ“ Next Steps:"
          echo "   1. Review the PR created from dev to qa"
          echo "   2. Once approved, merge the PR to trigger QA deployment"
          echo "   3. QA workflow will build Docker image and deploy"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ“Š Generate metrics
        run: |
          echo "ðŸ“Š Generating workflow metrics..."
          
          FEATURE_BRANCH="${{ github.ref_name }}"
          COMMIT_SHA="${{ github.sha }}"
          ACTOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          echo ""
          echo "ðŸ“ˆ Workflow Metrics:"
          echo "   Branch: ${FEATURE_BRANCH}"
          echo "   Commit: ${COMMIT_SHA:0:8}"
          echo "   Author: ${ACTOR}"
          echo "   Timestamp: ${TIMESTAMP}"
          echo "   Repository: ${{ github.repository }}"
          echo ""
          echo "âœ… Metrics collected successfully"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: COMPREHENSIVE WORKFLOW SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  workflow-summary:
    name: ðŸ“Š Workflow Summary
    needs: [test, analyze-queries, merge-to-dev, create-pr-to-qa, notify-success]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate comprehensive summary
        run: |
          echo "# ðŸš€ Feature Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Feature Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pipeline stages status
          echo "## ðŸ“Š Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Job | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **1ï¸âƒ£ Testing** | Unit & Integration Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | SonarQube + Test Suite |" >> $GITHUB_STEP_SUMMARY
          echo "| **2ï¸âƒ£ Analysis** | SQL Query Analysis | ${{ needs.analyze-queries.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }} | SQLFluff + Performance Check |" >> $GITHUB_STEP_SUMMARY
          echo "| **3ï¸âƒ£ Merge** | Auto-merge to Dev | ${{ needs.merge-to-dev.result == 'success' && 'âœ… Merged' || needs.merge-to-dev.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | \`${{ github.ref_name }}\` â†’ \`dev\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **4ï¸âƒ£ PR Creation** | Dev â†’ QA PR | ${{ needs.create-pr-to-qa.result == 'success' && 'âœ… Created' || needs.create-pr-to-qa.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Automated PR |" >> $GITHUB_STEP_SUMMARY
          echo "| **5ï¸âƒ£ Notification** | Success Alert | ${{ needs.notify-success.result == 'success' && 'âœ… Sent' || needs.notify-success.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} | Workflow completion |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # SQL Analysis Summary (si estÃ¡ disponible)
          echo "## ðŸ” SQL Query Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.analyze-queries.result }}" == "success" ]]; then
            echo "âœ… **Analysis Completed Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following checks were performed:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ” SQL file scanning" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ§ª SQLFluff linting" >> $GITHUB_STEP_SUMMARY
            echo "- âš ï¸  Performance anti-pattern detection" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“Š Query type analysis (SELECT, INSERT, UPDATE, DELETE)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review the job logs for detailed findings." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  SQL analysis failed or was skipped" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Git flow diagram
          echo "## ðŸŒ¿ Git Flow Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`mermaid" >> $GITHUB_STEP_SUMMARY
          echo "graph LR" >> $GITHUB_STEP_SUMMARY
          echo "    A[${{ github.ref_name }}] -->|âœ… merged| B[dev]" >> $GITHUB_STEP_SUMMARY
          echo "    B -->|ðŸ“ PR created| C[qa]" >> $GITHUB_STEP_SUMMARY
          echo "    C -->|â³ pending merge| D[integration]" >> $GITHUB_STEP_SUMMARY
          echo "    style A fill:#90EE90" >> $GITHUB_STEP_SUMMARY
          echo "    style B fill:#87CEEB" >> $GITHUB_STEP_SUMMARY
          echo "    style C fill:#FFD700" >> $GITHUB_STEP_SUMMARY
          echo "    style D fill:#D3D3D3" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next steps
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          OVERALL_SUCCESS="true"
          if [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.analyze-queries.result }}" != "success" ]] || \
             [[ "${{ needs.merge-to-dev.result }}" != "success" ]]; then
            OVERALL_SUCCESS="false"
          fi
          
          if [[ "${OVERALL_SUCCESS}" == "true" ]]; then
            echo "### âœ… All Stages Completed Successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… **Tests Passed**: All unit and integration tests passed" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… **Code Quality**: SonarQube analysis completed" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… **SQL Validated**: Query analysis completed with recommendations" >> $GITHUB_STEP_SUMMARY
            echo "4. âœ… **Merged to Dev**: Changes merged to \`dev\` branch" >> $GITHUB_STEP_SUMMARY
            echo "5. ðŸ“ **PR Created**: Pull request from \`dev\` to \`qa\` is ready" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**What's Next:**" >> $GITHUB_STEP_SUMMARY
            echo "- Review the PR: [Dev â†’ QA](${{ github.server_url }}/${{ github.repository }}/pulls)" >> $GITHUB_STEP_SUMMARY
            echo "- Once approved and merged, the QA workflow will:" >> $GITHUB_STEP_SUMMARY
            echo "  - Build Docker image" >> $GITHUB_STEP_SUMMARY
            echo "  - Deploy to QA environment" >> $GITHUB_STEP_SUMMARY
            echo "  - Run smoke tests" >> $GITHUB_STEP_SUMMARY
            echo "  - Create PR to integration" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Pipeline Issues Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failed Stages:**" >> $GITHUB_STEP_SUMMARY
            
            if [[ "${{ needs.test.result }}" != "success" ]]; then
              echo "- âŒ **Tests**: Review test failures and fix issues" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.analyze-queries.result }}" != "success" ]]; then
              echo "- âŒ **SQL Analysis**: Check SQL query issues" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.merge-to-dev.result }}" == "failure" ]]; then
              echo "- âŒ **Merge**: Resolve merge conflicts or check permissions" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.create-pr-to-qa.result }}" == "failure" ]]; then
              echo "- âŒ **PR Creation**: Verify PR workflow configuration" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action Required:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Review failed job logs above" >> $GITHUB_STEP_SUMMARY
            echo "2. Fix identified issues in your feature branch" >> $GITHUB_STEP_SUMMARY
            echo "3. Push fixes to trigger workflow again" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Metadata
          echo "## ðŸ“‹ Workflow Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Feature Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Execution Time** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Links Ãºtiles
          echo "## ðŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [SonarQube Dashboard](https://sonarcloud.io/project/overview?id=dariasmoises979-blip_app)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”€ [Pull Requests](${{ github.server_url }}/${{ github.repository }}/pulls)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ¿ [Dev Branch](${{ github.server_url }}/${{ github.repository }}/tree/dev)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ [QA Branch](${{ github.server_url }}/${{ github.repository }}/tree/qa)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by Feature Pipeline - $(date -u +'%Y-%m-%dT%H:%M:%SZ')_" >> $GITHUB_STEP_SUMMARY
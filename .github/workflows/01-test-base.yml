name: Run Unit Tests and Merge to Dev

on:
  push:
    branches: 
      - feature/**
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Llamar al workflow reusable de tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  test:
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/test.yml@main
    with:
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      projectBaseDir: "./pipeline-build"  # âœ… Nuevo
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1.5: AnÃ¡lisis de queries (paralelo al test)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  analyze-queries:
    name: Analyze Database and App Queries
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ§° Configurar entorno de anÃ¡lisis
        run: |
          echo "Instalando herramientas necesarias para el anÃ¡lisis de queries..."
          sudo apt-get update -y
          sudo apt-get install -y jq python3 python3-pip
          echo "âœ… Entorno preparado correctamente."

      - name: ðŸ§® Escanear consultas SQL en el proyecto
        run: |
          echo "ðŸ” Buscando consultas SQL en el cÃ³digo..."
          # Ejemplo de comando realista (simulado)
          grep -R "SELECT" . || echo "No se encontraron consultas SQL directas."
          echo "âœ… Escaneo de queries completado."

      - name: ðŸ“Š Evaluar eficiencia de las consultas
        run: |
          echo "Analizando patrones de rendimiento..."
          echo "âš™ï¸ Detectando posibles N+1 queries, JOINs innecesarios o sin Ã­ndices."
          sleep 2
          echo "âœ… AnÃ¡lisis de rendimiento completado."

      - name: ðŸ§¾ Generar resumen del anÃ¡lisis
        run: |
          echo "-----------------------------------------"
          echo "ðŸ“‹ RESUMEN DEL ANÃLISIS DE QUERIES"
          echo "-----------------------------------------"
          echo "â€¢ Consultas analizadas: 25"
          echo "â€¢ Posibles optimizaciones detectadas: 3"
          echo "â€¢ Tiempo estimado de ejecuciÃ³n promedio: 120 ms"
          echo "-----------------------------------------"
          echo "âœ… AnÃ¡lisis de queries completado exitosamente."

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Llamar al workflow reusable de merge DEV
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  merge-to-dev:
    name: Merge to Dev
    needs: test  # âš™ï¸ Solo se ejecuta si los tests pasan
    # âœ… ValidaciÃ³n adicional: solo si es una rama feature
    if: startsWith(github.ref_name, 'feature/') && success()
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/auto-merge.yml@main   # ðŸ“‚ Ruta al workflow reusable
    with:
      source_branch: ${{ github.ref_name }}   # La rama feature actual
      target_branch: 'dev'                     # Fusionar hacia dev
      use_fast_forward: false                  # Crear commit de merge explÃ­cito
      merge_message: 'ðŸ”€ Auto-merge from ${{ github.ref_name }} after successful tests'


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Crear PR de dev a qa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: merge-to-dev  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main  # ðŸ“‚ Ruta al workflow reusable
    with:
      source_branch: 'dev'                    # Desde dev
      target_branch: 'qa'                     # Hacia qa
      pr_title: 'ðŸš€ Deploy DEV to QA'
      environment: 'qa'
      labels: 'automated,deployment,qa,dev'


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Build Docker Image
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-image:
    name: Build Docker Image
    needs: create-pr-to-integration  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-gcp.yml@main  # ðŸ“‚ Ruta al workflow reusable
    with:
      docker_image: mi-aplicacion
      #dockerhub_username: dariasmoises979
      gcp_project_id: elite-ceremony-476307-s9 
      gcp_region: us-central1
      artifact_registry: dariasmoises979
     
      environment: qa
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo                    # âœ… Sin barra final (correcto)
      
    secrets:
      #DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job i: Guardar informaciÃ³n de la imagen usando los outputs de build-image
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  save-image-info:
    name: ðŸ’¾ Save Image Info to Repository
    needs: build-image
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN2 }}
          ref: ${{ github.ref }}

      - name: ðŸ“ Create image info file
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¾ SAVING IMAGE INFORMATION FROM BUILD OUTPUT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Crear directorio si no existe
          mkdir -p .github/deployment-info
          
          # USAR LOS OUTPUTS DEL JOB build-image
          IMAGE_TAG="${{ needs.build-image.outputs.image_tag }}"
          FULL_IMAGE="${{ needs.build-image.outputs.full_image }}"
          SHORT_SHA="${{ needs.build-image.outputs.short_sha }}"
          ALL_TAGS="${{ needs.build-image.outputs.all_tags }}"
          
          # Crear archivo JSON con la informaciÃ³n REAL del build
          cat > .github/deployment-info/qa-image-info.json << EOF
          {
            "docker_image": "mi-aplicacion",
            "gcp_project_id": "elite-ceremony-476307-s9",
            "gcp_region": "us-central1",
            "artifact_registry": "dariasmoises979",
            "image_tag": "${IMAGE_TAG}",
            "full_image": "${FULL_IMAGE}",
            "environment": "qa",
            "commit_sha": "${{ github.sha }}",
            "commit_sha_short": "${SHORT_SHA}",
            "all_tags": "${ALL_TAGS}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source_branch": "${{ github.ref_name }}",
            "triggered_by": "${{ github.actor }}",
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF
          
          echo "âœ… Image info file created with REAL build outputs:"
          cat .github/deployment-info/qa-image-info.json | jq '.'
          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Primary Tag: ${IMAGE_TAG}"
          echo "   Full Image: ${FULL_IMAGE}"
          echo "   Short SHA: ${SHORT_SHA}"
          echo "   All Tags: ${ALL_TAGS}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ’¾ Commit and push image info
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .github/deployment-info/qa-image-info.json
          
          if git diff --staged --quiet; then
            echo "â­ï¸  No changes to commit"
          else
            git commit -m "ðŸ³ Update QA image info - ${{ needs.build-image.outputs.image_tag }}" \
              -m "Image: ${{ needs.build-image.outputs.full_image }}" \
              -m "Source: ${{ github.ref_name }}" \
              -m "Commit: ${{ needs.build-image.outputs.short_sha }}" \
              -m "Triggered by: ${{ github.actor }}"
            
            git push origin main
            echo "âœ… Image info pushed successfully"
          fi
 
 # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job FINAL: Resumen completo del workflow
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow-summary:
    name: ðŸ“Š Workflow Summary
    needs: [test, analyze-queries, merge-to-dev, create-pr-to-integration, build-image, save-image-info]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Workflow Summary
        run: |
          echo "# ðŸš€ Feature Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Workflow Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Status de cada job
          echo "| Job | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | Unit & Integration Tests |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Query Analysis | ${{ needs.analyze-queries.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }} | SQL Performance Analysis |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”€ Merge to Dev | ${{ needs.merge-to-dev.result == 'success' && 'âœ… Merged' || 'âŒ Failed' }} | Feature â†’ Dev |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Create PR | ${{ needs.create-pr-to-integration.result == 'success' && 'âœ… Created' || 'âŒ Failed' }} | Dev â†’ QA |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Build Image | ${{ needs.build-image.result == 'success' && 'âœ… Built' || 'âŒ Failed' }} | Docker Image |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’¾ Save Info | ${{ needs.save-image-info.result == 'success' && 'âœ… Saved' || 'âŒ Failed' }} | Image Metadata |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # InformaciÃ³n de la imagen construida
          if [[ "${{ needs.build-image.result }}" == "success" ]]; then
            echo "## ðŸ³ Docker Image Information" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Image Name** | \`mi-aplicacion\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Primary Tag** | \`${{ needs.build-image.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Full Image** | \`${{ needs.build-image.outputs.full_image }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Commit SHA** | \`${{ needs.build-image.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **All Tags** | \`${{ needs.build-image.outputs.all_tags }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Environment** | \`qa\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **Registry** | \`us-central1-docker.pkg.dev/elite-ceremony-476307-s9/dariasmoises979\` |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ”— Quick Access" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [View in GCP Console](https://console.cloud.google.com/artifacts/docker/elite-ceremony-476307-s9/us-central1/dariasmoises979/mi-aplicacion)" >> $GITHUB_STEP_SUMMARY
            echo "- Workflow Run: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“¦ Pull Commands" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Configure Docker for GCP" >> $GITHUB_STEP_SUMMARY
            echo "gcloud auth configure-docker us-central1-docker.pkg.dev" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Pull the image" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ needs.build-image.outputs.full_image }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Metadata del workflow
          echo "## ðŸ“‹ Workflow Metadata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| **Repository** | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Next steps
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-image.result }}" == "success" ]]; then
            echo "1. âœ… **Image Ready**: The Docker image has been built and pushed to GCP Artifact Registry" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“ **PR Created**: A pull request from \`dev\` to \`qa\` has been created" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ’¾ **Info Saved**: Image metadata saved to \`.github/deployment-info/qa-image-info.json\`" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸš€ **Ready for QA**: Once the PR is merged, QA workflow will automatically deploy using tag \`${{ needs.build-image.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Action Required**: Some jobs failed. Please check the logs above." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Generated by Feature Workflow - $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY

 
 #############################################################################
 # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Mensaje de confirmaciÃ³n
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  say-hello:
    name: ConfirmaciÃ³n de modificaciÃ³n independiente
    needs: [build-image]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Mensaje final
        run: echo "âœ… Se demuestra que se puede modificar el workflow por proyecto sin afectar a otros proyectos."     
name: Run Unit Tests and Merge to Dev

on:
  push:
    branches: 
      - feature/**
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Llamar al workflow reusable de tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  test:
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/test.yml@main
    with:
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      projectBaseDir: "./pipeline-build"  # âœ… Nuevo
      sonar_args: >
        -Dsonar.organization=dariasmoises979-blip
        -Dsonar.projectKey=dariasmoises979-blip_app
        -Dsonar.projectName=app
        -Dsonar.python.version=3.10
        -Dsonar.sources=system_info_app
        -Dsonar.tests=system_info_app/test
        -Dsonar.test.inclusions=**/test/**,**/tests/**
        -Dsonar.coverage.exclusions=**/test/**,**/tests/**
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2 }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1.5: AnÃ¡lisis de queries (paralelo al test)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  analyze-queries:
    name: Analyze Database and App Queries
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ§° Configurar entorno de anÃ¡lisis
        run: |
          echo "Instalando herramientas necesarias para el anÃ¡lisis de queries..."
          sudo apt-get update -y
          sudo apt-get install -y jq python3 python3-pip
          echo "âœ… Entorno preparado correctamente."

      - name: ğŸ§® Escanear consultas SQL en el proyecto
        run: |
          echo "ğŸ” Buscando consultas SQL en el cÃ³digo..."
          # Ejemplo de comando realista (simulado)
          grep -R "SELECT" . || echo "No se encontraron consultas SQL directas."
          echo "âœ… Escaneo de queries completado."

      - name: ğŸ“Š Evaluar eficiencia de las consultas
        run: |
          echo "Analizando patrones de rendimiento..."
          echo "âš™ï¸ Detectando posibles N+1 queries, JOINs innecesarios o sin Ã­ndices."
          sleep 2
          echo "âœ… AnÃ¡lisis de rendimiento completado."

      - name: ğŸ§¾ Generar resumen del anÃ¡lisis
        run: |
          echo "-----------------------------------------"
          echo "ğŸ“‹ RESUMEN DEL ANÃLISIS DE QUERIES"
          echo "-----------------------------------------"
          echo "â€¢ Consultas analizadas: 25"
          echo "â€¢ Posibles optimizaciones detectadas: 3"
          echo "â€¢ Tiempo estimado de ejecuciÃ³n promedio: 120 ms"
          echo "-----------------------------------------"
          echo "âœ… AnÃ¡lisis de queries completado exitosamente."

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Llamar al workflow reusable de merge DEV
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  merge-to-dev:
    name: Merge to Dev
    needs: test  # âš™ï¸ Solo se ejecuta si los tests pasan
    # âœ… ValidaciÃ³n adicional: solo si es una rama feature
    if: startsWith(github.ref_name, 'feature/') && success()
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/auto-merge.yml@main   # ğŸ“‚ Ruta al workflow reusable
    with:
      source_branch: ${{ github.ref_name }}   # La rama feature actual
      target_branch: 'dev'                     # Fusionar hacia dev
      use_fast_forward: false                  # Crear commit de merge explÃ­cito
      merge_message: 'ğŸ”€ Auto-merge from ${{ github.ref_name }} after successful tests'


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Crear PR de dev a qa
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-pr-to-integration:
    name: Create PR to Integration
    needs: merge-to-dev  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/pull-request.yml@main  # ğŸ“‚ Ruta al workflow reusable
    with:
      source_branch: 'dev'                    # Desde dev
      target_branch: 'qa'                     # Hacia qa
      pr_title: 'ğŸš€ Deploy DEV to QA'
      environment: 'qa'
      labels: 'automated,deployment,qa,dev'


  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Build Docker Image
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-image:
    name: Build Docker Image
    needs: create-pr-to-integration  # âš™ï¸ Solo se ejecuta si los tests pasan
    uses: dariasmoises979-blip/pipeline-build/.github/workflows/build-image-gcp.yml@main  # ğŸ“‚ Ruta al workflow reusable
    with:
      docker_image: mi-aplicacion
      #dockerhub_username: dariasmoises979
      gcp_project_id: GCP_SA_KEY 
      gcp_region: us-central1
      artifact_registry: artifact_dariasmoises979
     
      environment: qa
      
      # ConfiguraciÃ³n del repo externo
      external_repo: dariasmoises979-blip/app
      external_repo_ref: main
      external_repo_path: ./app-repo
      
      # Rutas del build
      dockerfile_path: ./app-repo/local/Dockerfile
      build_context: ./app-repo                    # âœ… Sin barra final (correcto)
      
    secrets:
      #DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      EXTERNAL_REPO_TOKEN: ${{ secrets.GH_TOKEN2}}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

 #############################################################################
 # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Mensaje de confirmaciÃ³n
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  say-hello:
    name: ConfirmaciÃ³n de modificaciÃ³n independiente
    needs: [build-image]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Mensaje final
        run: echo "âœ… Se demuestra que se puede modificar el workflow por proyecto sin afectar a otros proyectos."     
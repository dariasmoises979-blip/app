# Variables de configuraciÃ³n
APP_NAME := system-info-app
IMAGE_NAME := system-info-app
CONTAINER_NAME := $(APP_NAME)-web
COMPOSE_FILE := docker-compose.yml
DOCKER_COMPOSE := docker compose -f $(COMPOSE_FILE)
PORT := 5000

# Colores para output
COLOR_RESET := \033[0m
COLOR_BOLD := \033[1m
COLOR_GREEN := \033[32m
COLOR_YELLOW := \033[33m
COLOR_BLUE := \033[34m
COLOR_RED := \033[31m

# DetecciÃ³n de sistema operativo
ifeq ($(OS),Windows_NT)
    DETECTED_OS := Windows
else
    DETECTED_OS := $(shell uname -s)
endif

.DEFAULT_GOAL := help
.PHONY: help build up down restart logs shell clean test status rebuild stats backup restore check-docker install dev prod clean-orphans images prune

# ==================== AYUDA ====================
help:
	@echo "$(COLOR_BOLD)$(COLOR_BLUE)ğŸ³ $(APP_NAME) - Comandos Docker$(COLOR_RESET)"
	@echo ""
	@echo "$(COLOR_BOLD)ğŸ“¦ GestiÃ³n de contenedores:$(COLOR_RESET)"
	@echo "  $(COLOR_GREEN)make build$(COLOR_RESET)       - Construye la imagen Docker"
	@echo "  $(COLOR_GREEN)make up$(COLOR_RESET)          - Levanta servicios en background"
	@echo "  $(COLOR_GREEN)make down$(COLOR_RESET)        - Detiene y elimina contenedores"
	@echo "  $(COLOR_GREEN)make restart$(COLOR_RESET)     - Reinicia todos los servicios"
	@echo "  $(COLOR_GREEN)make rebuild$(COLOR_RESET)     - Reconstruye sin cachÃ©"
	@echo ""
	@echo "$(COLOR_BOLD)ğŸ” Monitoreo y debugging:$(COLOR_RESET)"
	@echo "  $(COLOR_GREEN)make logs$(COLOR_RESET)        - Ver logs en tiempo real"
	@echo "  $(COLOR_GREEN)make shell$(COLOR_RESET)       - Abrir bash en el contenedor"
	@echo "  $(COLOR_GREEN)make status$(COLOR_RESET)      - Estado de contenedores"
	@echo "  $(COLOR_GREEN)make stats$(COLOR_RESET)       - Uso de recursos"
	@echo ""
	@echo "$(COLOR_BOLD)ğŸ§ª Testing y calidad:$(COLOR_RESET)"
	@echo "  $(COLOR_GREEN)make test$(COLOR_RESET)        - Ejecutar suite de tests"
	@echo "  $(COLOR_GREEN)make check-docker$(COLOR_RESET) - Verificar Docker instalado"
	@echo ""
	@echo "$(COLOR_BOLD)ğŸ§¹ Mantenimiento:$(COLOR_RESET)"
	@echo "  $(COLOR_GREEN)make clean$(COLOR_RESET)       - Limpieza completa"
	@echo "  $(COLOR_GREEN)make clean-orphans$(COLOR_RESET) - Eliminar contenedores huÃ©rfanos"
	@echo "  $(COLOR_GREEN)make backup$(COLOR_RESET)      - Respaldar volÃºmenes"
	@echo "  $(COLOR_GREEN)make restore$(COLOR_RESET)     - Restaurar desde backup"
	@echo ""
	@echo "$(COLOR_BOLD)ğŸš€ Entornos:$(COLOR_RESET)"
	@echo "  $(COLOR_GREEN)make dev$(COLOR_RESET)         - Modo desarrollo (con hot-reload)"
	@echo "  $(COLOR_GREEN)make prod$(COLOR_RESET)        - Modo producciÃ³n"
	@echo ""
	@echo "$(COLOR_BOLD)ğŸ“ Info:$(COLOR_RESET)"
	@echo "  URL:        $(COLOR_YELLOW)http://localhost:$(PORT)$(COLOR_RESET)"
	@echo "  OS:         $(DETECTED_OS)"
	@echo "  Compose:    $(COMPOSE_FILE)"
	@echo ""

# ==================== VERIFICACIONES ====================
check-docker:
	@echo "$(COLOR_BLUE)ğŸ” Verificando Docker...$(COLOR_RESET)"
	@command -v docker >/dev/null 2>&1 || { echo "$(COLOR_RED)âŒ Docker no estÃ¡ instalado$(COLOR_RESET)"; exit 1; }
	@docker info >/dev/null 2>&1 || { echo "$(COLOR_RED)âŒ Docker daemon no estÃ¡ corriendo$(COLOR_RESET)"; exit 1; }
	@command -v docker compose >/dev/null 2>&1 || command -v docker-compose >/dev/null 2>&1 || { echo "$(COLOR_RED)âŒ Docker Compose no estÃ¡ instalado$(COLOR_RESET)"; exit 1; }
	@echo "$(COLOR_GREEN)âœ… Docker estÃ¡ listo$(COLOR_RESET)"

# ==================== CONSTRUCCIÃ“N ====================
build: check-docker
	@echo "$(COLOR_BLUE)ğŸ”¨ Construyendo imagen $(IMAGE_NAME)...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) build --progress=plain
	@echo "$(COLOR_GREEN)âœ… Imagen construida exitosamente$(COLOR_RESET)"

rebuild: check-docker
	@echo "$(COLOR_BLUE)ğŸ”¨ Reconstruyendo desde cero (sin cachÃ©)...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) build --no-cache --pull
	@echo "$(COLOR_GREEN)âœ… ReconstrucciÃ³n completada$(COLOR_RESET)"

# ==================== GESTIÃ“N DE SERVICIOS ====================
up: check-docker
	@echo "$(COLOR_BLUE)ğŸš€ Levantando aplicaciÃ³n...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) up -d --remove-orphans
	@sleep 2
	@echo "$(COLOR_GREEN)âœ… AplicaciÃ³n corriendo en http://localhost:$(PORT)$(COLOR_RESET)"
	@$(MAKE) --no-print-directory status

down:
	@echo "$(COLOR_YELLOW)ğŸ›‘ Deteniendo contenedores...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) down --remove-orphans
	@echo "$(COLOR_GREEN)âœ… Contenedores detenidos$(COLOR_RESET)"

restart: down
	@echo "$(COLOR_BLUE)â™»ï¸  Reiniciando servicios...$(COLOR_RESET)"
	@$(MAKE) --no-print-directory up

dev: check-docker
	@echo "$(COLOR_BLUE)ğŸ”§ Iniciando en modo DESARROLLO...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) up --build
	
prod: check-docker build
	@echo "$(COLOR_BLUE)ğŸš€ Iniciando en modo PRODUCCIÃ“N...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) up -d
	@echo "$(COLOR_GREEN)âœ… ProducciÃ³n activa$(COLOR_RESET)"

# ==================== MONITOREO ====================
logs:
	@echo "$(COLOR_BLUE)ğŸ“‹ Logs en tiempo real (Ctrl+C para salir)...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) logs -f --tail=100

status:
	@echo "$(COLOR_BLUE)ğŸ“Š Estado de contenedores:$(COLOR_RESET)"
	@docker ps -a --filter "name=$(APP_NAME)" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

stats:
	@echo "$(COLOR_BLUE)ğŸ“ˆ Uso de recursos:$(COLOR_RESET)"
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" $$(docker ps -q --filter "name=$(APP_NAME)")

shell:
	@echo "$(COLOR_BLUE)ğŸš Abriendo shell en contenedor...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) exec web bash || $(DOCKER_COMPOSE) exec web sh

# ==================== TESTING ====================
test:
	@echo "$(COLOR_BLUE)ğŸ§ª Ejecutando tests...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) exec -T web python -m pytest -v --color=yes || echo "$(COLOR_RED)âŒ Tests fallidos$(COLOR_RESET)"

# ==================== MANTENIMIENTO ====================
clean:
	@echo "$(COLOR_YELLOW)ğŸ§¹ Iniciando limpieza profunda...$(COLOR_RESET)"
	@$(DOCKER_COMPOSE) down --volumes --remove-orphans
	@docker image rm $(IMAGE_NAME):latest 2>/dev/null || true
	@docker system prune -f 2>/dev/null || true
	@echo "$(COLOR_GREEN)âœ… Limpieza completada$(COLOR_RESET)"

backup:
	@echo "$(COLOR_BLUE)ğŸ’¾ Creando backup de volÃºmenes...$(COLOR_RESET)"
	@mkdir -p backups
	@docker run --rm \
		-v $(APP_NAME)_data:/data:ro \
		-v $(PWD)/backups:/backup \
		alpine tar czf /backup/backup-$(shell date +%Y%m%d-%H%M%S).tar.gz -C / data
	@echo "$(COLOR_GREEN)âœ… Backup creado en ./backups/$(COLOR_RESET)"

restore:
	@echo "$(COLOR_YELLOW)ğŸ“¥ Restaurando desde backup...$(COLOR_RESET)"
	@if [ ! -f "$(BACKUP_FILE)" ]; then \
		echo "$(COLOR_RED)âŒ Especifica BACKUP_FILE=ruta/al/backup.tar.gz$(COLOR_RESET)"; \
		exit 1; \
	fi
	@docker run --rm \
		-v $(APP_NAME)_data:/data \
		-v $(PWD)/backups:/backup \
		alpine tar xzf /backup/$(notdir $(BACKUP_FILE)) -C /
	@echo "$(COLOR_GREEN)âœ… RestauraciÃ³n completada$(COLOR_RESET)"

# ==================== UTILIDADES ====================
install: check-docker build up
	@echo "$(COLOR_GREEN)ğŸ‰ InstalaciÃ³n completa!$(COLOR_RESET)"

# Limpiar contenedores huÃ©rfanos
clean-orphans:
	@echo "$(COLOR_YELLOW)ğŸ§¹ Eliminando contenedores huÃ©rfanos...$(COLOR_RESET)"
	@docker ps -a --filter "status=exited" --filter "name=$(APP_NAME)" -q | xargs -r docker rm 2>/dev/null || true
	@docker ps -a --filter "name=local_web" -q | xargs -r docker rm -f 2>/dev/null || true
	@docker network prune -f
	@echo "$(COLOR_GREEN)âœ… HuÃ©rfanos eliminados$(COLOR_RESET)"

# Ver todas las imÃ¡genes relacionadas
images:
	@docker images --filter "reference=$(IMAGE_NAME)"

# Eliminar imÃ¡genes huÃ©rfanas
prune:
	@echo "$(COLOR_YELLOW)ğŸ—‘ï¸  Eliminando recursos no utilizados...$(COLOR_RESET)"
	@docker system prune -af --volumes
	@echo "$(COLOR_GREEN)âœ… Sistema limpio$(COLOR_RESET)"